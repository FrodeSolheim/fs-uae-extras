<HTML>
<HEAD>
<TITLE>Programování WHDLoad</TITLE>
<meta name="DC.Language" content="cz">
<meta http-equiv="content-language" content="cz">
<meta http-equiv="content-type" content="text/html; charset=windows-1250">
<!-- $Id: howto.html 1.5 2014/12/04 23:37:38 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Schematic execution flow</h3>
<p>Následující tabulka ukazuje, jak pracuje program, kdy je spusten program nainstalovanı
WHDLoadem. Doufám, e to pomùe pochopit, jak WHDLoad pracuje a jak WHDLoad,
slave a nainstalovanı program spolupracují.</p>
<table cellpadding=3>
  <tr>
    <td valign=top>Uivatel</td>
    <td>
      <ul>
        <li>spustí demo nebo hru kliknutím na ikonu nebo spuštìním WHDLoad pøes pøíkazovou øádku
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>Operaèní systém</td>
    <td valign=top>
      <ul>
        <li>nahraje executable WHDLoadu a spustí ho
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>WHDLoad</td>
    <td>
      <ul>
        <li>testuje softwarové a hardwarové prostøedí
        <li>nahraje a testuje slave
        <li>zabere poadovanou pame pro program
        <li>pokud je zapnut<a href="opt.html#Preload">Preload/S</a>, nahravá disk image a soubory
            do RAM dokud je pro nì dostatek volné pamìti
        <li>vypíná OS (zastaví mutitasking a pøerušení, degraduje grafickı hardware
            na OCS, inicializuje všechen hardware s definovanımi hodnotami)
        <li>skoèí do kodu slave
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>Slave</td>
    <td>
      <ul>
        <li>nahraje hlavní executable nainstalovaného programu voláním WHDLoad funkce
            (napø. <a href="../autodoc.html#resload_DiskLoad">resload_DiskLoad</a> or <a
            href="../autodoc.html#resload_LoadFile">resload_LoadFile</a>)
        <li>patchuje (upraví) hlavní executable (take program bude nahrávat svá data
            pøes slave, odstraní se problémy s nekompatibilitou, a je umonìn exit z programu)
        <li>skoèí do hlavního executable hry nebo dema
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>Nainstalovanı program</td>
    <td>
      <ul>
        <li>dìlá svou vlastní práci
        <li>pøi nahrávání dat z disku volá Slave (protoe Slave ho pøedtím tak upravil)
            a slave volá WHDLoad a WHDLoad èásteènì zapne OS, aby nahrál data
            (ale jen pokud data nejsou <a href="opt.html#Preload">Preload</a>nuta), pak se vráti
            z OS, WHDload, slavu a nainstalovanı program pokraèuje dál
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>Uivatel</td>
    <td>
      <ul>
        <li>vyskoèí z programu pomocí <a href="opt.html#QuitKey">QuitKey</a>
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>Slave</td>
    <td>
      <ul>
        <li>vrací se do WHDLoad voláním <a href="../autodoc.html#resload_Abort">resload_Abort</a>
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>WHDLoad</td>
    <td>
      <ul>
        <li>odblokuje OS (vrátí hodnoty hardware registru, display a pamì)
        <li>uvolní všechny zabrané zdroje
        <li>vrací se do OS
      </ul>
    </td>
  </tr>
</table>
<h3>Jak nainstalovat jednoduchı trackloader jednodisketové hry</h3>
Tohle je velmi malı a krátkı názornı návod, jak vytvoøit instalaèku k NDOS høe/demu pomocí WHDLoad.
Návod ukazuje ideální jednoduchı pøípad. Ve skuteènosti takovı pøípad ale asi
nikdy nestane, take pro speciální pøípady a problémy ètìte následující kapitoly.
<ol>
  <li>Pøíprava
    <ul>
      <li>Vytvoøte adresáø, kterı obsahuje všechny soubory
      <li>Vytvoøte disk image pomocí <A HREF="dic.html"> DIC </A> a pøesuòte ho do našeho adresáøe.
      <li>Vytvoøte <a href="opt.html#optwb">ikonu</a> s "WHDLoad" jako &lt;Default Tool&gt; a tooltypem "SLAVE=#?" obsahujícím jméno slave
          (nebo jednoduše pøekopírujte ikonu z ukázkovıch instalací a odstraòte všechny tooltype kromì  "SLAVE="
    </ul>
  <li>Slave<br>
    Pro napsání slave potøebujeme následující informace:
    <ol>
      <li>Kde na disku je hlavní executable?
      <li>Kde uvnitø hlavního executable je disk loader? (=nahrávací rutina)
    </ol>
    Pro tuhle informaci nejdøíve analyzujeme bootblock. Vìtšinou je executable nahranı
    pomocí funkce exec.DoIO(), nìkdy je ale v bootblocku speciální trackloader.
    Napíšeme slave, kterı simuluje bootblock a nahraje hlavní executable z disk image.
    Teï vytvoøíme <a href="dump.html#memory">memory dump</a>, disassemblujeme ji a poté musíme najít loader.
    v hlavním executable. Nejrychlejší je hledat hex-editorem øetìzec $AAAAAAAA (kterı je pouíván pro MFM dekódování)
    Pak si prohlédnout danou oblast (v rozsahu +/- $1000 bytes) a najít zaèátek rutiny.
    Najít parametry. Pak vytvoøíme kód pro slave, kterı upraví loader tak, aby byly všechny
    skoky na loader pøeøízenı dovnitø slave. Pak si slave pøizpùsobí parametry a s jejich
    pouitím volá WHDLoad funkci <a href="../autodoc.html#resload_DiskLoad">resload_DiskLoad</a>.
  <li>V ideálním  pøípadì je instalaèka hotová.<br>
Zbıvá u jen udìlat pìknou ikonu. Vyripujte WHDLoadem dva obrázky pouitím <a href="snoop.html">snoop modu</a> a <a href="sp.html">SP</a>
nebo freezerem nebo na U.A.E. a stvoøte ikonu. Šestnáctibarevná <a href="ftp://ftp.wustl.edu/pub/aminet/pix/mwb/RomIcons10.lha">RomIcon</a>
paleta je ideální (ale lze ikonu vytvoøit i pro víc formátù).
</ol>
<h3>Moné problémy a zvláštní pøípady</h3>
<h4>Nestandartní trackloader</h4>
Nìkteré programy mají svùj vlastní formát disku. To znamená, e <a href="dic.html">DIC</a> nemùe vytvoøit disk image.
Pro vytvoøení souboru nebo images z takového disku je nezbytné napsat speciální rutinu s pouitím
<a href="rawdic.html">RawDIC</a>. Pro více informací ètìte dokumentaci RawDIC.
<h4>Více diskù</h4>
Jestlie program pouívá víc ne jednu disketu, slave musí pøeøadit pøístup k disku
na odpovídající disk image soubor. Nìkdy je to tìké. Nìkteré programy umí pouít
víc disketovıch jednotek, take mùete pouít èíslo jednotky pro vybrání správného
image. Vìtšina programù hledá urèité ID na disku, aby je rozpoznala, v tomto pøípadì
dchyte kadou zkoušku ID (napø. analyzováním nahrávacích parametrù pro loader) a pøiøaïte správnou hodnotu.
Pak se ID naète ze správného disku a program uzná disk jako správnou vloenou disketu.
Pokud je zobrazenı poadavek pro vloení disku, odstraòte ho.
<h4>Ukládání Highscore</h4>
Pouijte <a href="../autodoc.html#resload_SaveFile">resload_SaveFile</a> k zapsání potøebné
oblasti pamìti na disk. Jestli chcete, zašifrujte vytvoøenı soubor, take lameøi
ho nebudou schopni editovat. Není dobré zapisovat highscore pøímo do disk image
(pouitím <a href="../autodoc.html#resload_SaveFileOffset">resload_SaveFileOffset</a>), protoe
pokud se nìco špatného pøihodí (tøeba se program sekne), mùe se stát, e image
se poškodí.
<h4>Ukládání pozic</h4>
To je stejnı pøípad jako u highscore, tady ale mame ulehcenou situaci tím,
e hra má pro ukládání pozice vlastní rutinu a parametry.
<h4>Pøístupy k operaènímu systému</h4>
V momentì, kdy je slave a instalovanı program vykonáván, neexistuje ádnı OS,
take ádnı pøístup k nìmu nebude fungovat! Všechny pøístupy hry nebo dema k OS
musí bıt odstranìny nebo emulovány. Pokud jich není moc a nemají ve WHDLoad
systému vıznam (napr.exec.Disable() nebo exec.SuperState()) prostì je odstraòte
pomocí NOP ($4e71). Pokud má volání OS dùleitou funkci (jako exec.DoIO()),
napište emulaci do slave.
 Pøístupy k OS jsou detekovány pomocí falešné adresy execbase, nastavené
na $f0000001, take všechny skoky do OS vyvolají chybu "Address Error".<br>
 Pokud je jich pøíliš mnoho, lze pouít jedno z KickEmu pluginu ve whdload-dev
archivu. Existuje emulace pro Kick 1.3 ('src/sources/whdload/kick13.s')
a pro Kick 3.1 ('src/sources/whdload/kick31.s'). Tato balení vyadují originální
kickstart ROM soubor a vytvoøí kompletní OS prostøedí uvnitø WHDLoad vesmíru.
Pøeètìte si také pøiloená readme v kadém archivu.
<h3>Obvyklá problémy kompatibility</h3>
<h4>Odlišné stackframes na kadém CPU</h4>
Stackframes tvoøené CPU pøerušeními a vyjímkami se u jednotlivıch CPU liší.
Na 68000 je stackframe 6 bajtù kromì sbìrnicovıch a adresovıch chyb. Stackframe
obsahuje hodnotu SR na (a7) a hodnotu PC na (2,a7). Na ostatních CPU je minimílní
stackframe 8 bajtù a dodateènì obsahuje èíslo vektoru jako word na (6,a7).
Tento ètyrwordovı format stackframu je vytvoøen pro "Trap #xx" a pøerušení na
68010-68060. Stackframes pro ostatní vyjímky jsou na kadém procesoru jiné.
Instrukce RTE funguje jinak na 68000 a jinak na 68010+. Na 68000 vrací hodnotu
do SR a pak se vrací na správnou adresu, kdeto na 68010+ navíc uvolní stackframe
podle adekvátního stackframe formátu. Nìkteré programy ukládají adresu a hodnotu
SR a pak vykonají RTE. Takhle to ale funguje jen na 68000, na jinıch CPU to má
neoèekáváné vısledky. Pokud se o to program pokouší, musíte to opravit. Nìkdy
staèí nahradit RTE s RTR.
<h4>MOVEM.x RL,-(An) na 68000/010 a 68020-68060</h4>
Je rozdíl, pokud registr pouitı v predecrement modu je také obsazen
v seznamu registrù. Pro 68020-68060 je hodnota zapsána do pamìti
poèáteèní hodnota registeru sníena rozsahem operace. 68000 a 68010 zapisují
pocateèní hodnotu registru (nesníenou). Tento efekt se ale nedá nijak vyuít,
take zatím není známo mnoho programù, co tento problém zpùsobijí.
<h3>Hlavní tipy pro psaní isnatlaèek</h3>
<ul>
<li>Nemodifikujte CPU registry na novìjších CPU jako jsou VBR a CACR.
VBR je vdycky na 0 z programatorskeho pohledu, i kdy je pøesunuto,
protoe autovektory (a vyjímky TRAP, pokud je flag <a href="../autodoc.html#WHDL_EmulTrap">WHDL_EmulTrap</a> nastaven)
jsou emulované. Bity v CACR se liší u kadého CPU. Je jenom jeden spravnı zpùsob
jak modifikovat cache, pouijte funkce <a href="../autodoc.html">resload_SetCACR/SetCPU</a>
a bitdef hodnoty z 'exec/execbase.i' a 'whdload.i'. Také veškerı kód v programu, kterı
hrabe na tyto registrı, musí bıt odstranìn nebo vynechán.
<li>Nikdy nemodifikujte disk image, protoe pokud nìkdo chce spustit program
z floppy, staèí mu pouze zapsat image zpatky na disk (ale pøedpokládá se, e
program musí bìet z diskety bez oprav a ádná stopa není ve speciálním formátu
nebo netvoøí ochranu disku).
<li> Nikdy nepouívejte binární kód z programu pøímo ve slave (copyright problem).
<li>Zapnìte Caches jen pokud jste si jisti, e program pobìí na všech procesorech.
<li>Pouívejte co nejménì pamìti pro <a href="../autodoc.html#ws_BaseMemSize">ws_BaseMemSize</a>. Nekteøí lidé mají
rezidentní tagy na konci Chip RAM a tak pomáhá pouít jen $1f0000 místo
$200000 a WHDLoad mùe pouít absolutní alokovanou pamì.
</ul>
</BODY>
</HTML>
