<HTML>
<HEAD>
<TITLE>Snooping</TITLE>
<meta name="DC.Language" content="cz">
<meta http-equiv="content-language" content="cz">
<meta http-equiv="content-type" content="text/html; charset=windows-1250">
<!-- $Id: snoop.html 1.5 2014/12/04 23:37:38 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Snooping</h3>
<h4>Co to je</h4>
Snooping je schopnost WHDLoad, která ovìøuje a loguje CPU pøístupy k custom a CIA registrùm.
Pokud je <a href="opt.html#Snoop">Snoop</a> aktivován, všechny nesprávné pøístupy k custom
registrùm vytvoøí chybu a nainstalovanı program bude ukonèen. WHDLoad zobrazí chybovı registr
vysvìtlující dùvod chyby.
<h4>Custom registry</h4>
Všechny pøístupy ètení/zápisu do custom registrù jsou kontrolovány. Nesprávné pøístupy jsou:
<ul>
<li>pøístupy k neexistujícím registrùm
<li>read pøístupy k Write Only registrùm
<li>write pøístupy k Read Only registrùm
<li>pøístupy k Early Read registrùm
<li>byte write pøístupy (krome <tt>bltcon0l</tt> a <tt>aud*vol+1</tt>)
</ul>
Strobe registry mohou bıt èteny nebo zapisovány.Custom registry se odlišují -
OCS (Old ChipSet - A500, A1000, old A2000), ECS (Enhanced ChipSet
- A600, nova A2000, A3000) a AGA (Advanced Graphics - A1200, A4000). Take se
tato funkce hodí obzvláštì pro hledání chyb ve starıch programech, zpùsobenıch
špatnım pøístupem k AGA registrùm.
<p>Pouívání funkce <a href="../autodoc.html#resload_Control">resload_Control</a> a tagù
 <a href="../autodoc.html#WHDLTAG_CUST">WHDLTAG_CUST_DISABLE/READ/STROBE/WRITE</a>
 se dá modifikovat vnitøní konfigurace WHDLoad toho, které registry mají bıt
 jen na ètení/zapisovatelné. Tím mohou bıt ignorovány ilegální pøístupy nebo mohou
 bıt detekovány ty správné. To by se mìlo pouívat jen pøi pracovním procesu a ne
 ve závereèné verzi slave k vydání.
<h4>Cia registry</h4>U Cia registrù jsou kontrolovány jen zápisy. To znamená,
e ètení neexistujících registrù v oblasti pamìti od $bfd000 do $bfefff
nebude detekováno. Pro všechny zápisy bude zapisovaná hodnota internì uloena
WHDLoadem. Pro nìkteré Cia registry jsou speciální kontroly, které ovìøují
zapisovanou hodnotu:

<p><table border=1 summary="tabulka cia registrù">
<tr>
	<th>adresa</th>
	<th>registr</th>
	<th>test</th>
</tr><tr>
	<td>$bfe001</td>
	<td>ciaa.ciapra</td>
	<td>nastavení Overlay bitu #0 je zakázáno</td>
</tr><tr>
	<td>$bfe201</td>
	<td>ciaa.ciaddra</td>
	<td>bity #6-7 mùou mít jakoukoliv hodnotu (vyuívá se pro joypad), niší bity musí bıt
	%000011</td>
</tr><tr>
	<td>$bfe801</td>
	<td>ciaa.ciatodlow</td>
	<td rowspan=3>read-modify-write zápisy (napøíklad pøes bchg) nejsou dovoleny
	pokud je nastaven ALARM bit v ciaa.ciacrb (ovìøuje se jen na 68060)</td>
</tr><tr>
	<td>$bfe901</td>
	<td>ciaa.ciatodmid</td>
</tr><tr>
	<td>$bfea01</td>
	<td>ciaa.ciatodhi</td>
</tr><tr>
	<td>$bfed01</td>
	<td>ciaa.ciaicr</td>
	<td>read-modify-write pøístupy (napøíklad bchg) nejsou dovoleny (ovìøováno na 68060)</td>
</tr><tr>
	<td>$bfd100</td>
	<td>ciab.ciaprb</td>
	<td>bity pro MOTOR #7, SELECT #3-6 a STEP #0 nesmí bıt vynulovány,
	ostatní bity mohou bıt zmìnìny, takhle se detekuje pøístup na disk</td>
</tr><tr>
	<td>$bfd200</td>
	<td>ciab.ciaddra</td>
	<td>zapsaná hodnota musí bıt %11000000</td>
</tr><tr>
	<td>$bfd300</td>
	<td>ciab.ciaddrb</td>
	<td>zapsaná hodnota musí bıt %11111111</td>
</tr><tr>
	<td>$bfd800</td>
	<td>ciab.ciatodlow</td>
	<td rowspan=3>read-modify-write pøístupy (napøíklad bchg) nejsou dovoleny,
	pokud je nastaven ALARM bit v ciab.ciacrb (ovìøováno jen na 68060)</td>
</tr><tr>
	<td>$bfd900</td>
	<td>ciab.ciatodmid</td>
</tr><tr>
	<td>$bfda00</td>
	<td>ciab.ciatodhi</td>
</tr><tr>
	<td>$bfdd00</td>
	<td>ciab.ciaicr</td>
	<td>read-modify-write pøístupy (napøíklad bchg) nejsou dovoleny (ovìøováno jen na 68060)</td>
</tr></table>

<h4>Jak to funguje</h4>
Pokud je snooping zapnutı, WHDLoad oznaèí adresy custom registrù v MMU translation
tree jako nesprávné/chránìné proti zápisu. Díky tomu se kadı pøístup do custom registrù stane Access Fault
vyjímkou. WHDload tuto vyjímku ovládá, take mùe zjistit, jestli je pøístup správnı
nebo ne (pøi nekorektním pøístupu je program ukonèen, jinak program pokraèuje).
<br>Kvùli pøetíení vyjímek a emulaèní sekvenci se bìh programu znaènì zpomalí.
Jak moc, záleí na CPU, typu Chip RAM a stackpointer aligmentu. Vše se take liší
podle druhu pøístupu (Byte/Word/LongWord, Read/Write). Na 68030 jsou zápisy
rychlejší ne ètení (protoe pøi ètení je stackframe 92 bajtu, pøi psaní 32),
na 68060 je to naopak, protoe emulace zápisu je sloitìjší.
<h4>Fast Snoop Mode</h4>
Volba Snoop/S zapíná rychlı snooping. Read pøístupy nebudou testovány.
ádné speciální zkoušky nejsou provedeny. Tento mód je uiteènı jen pro
získání obsahu custom registru, napø. pro uloení obrázku pomocí
<a href="sp.html">SP</a>.
<h4>Copper List Scanner</h4>
Od verze 13 budou zkoušeny také copperlisty. Scanner bude aktivován pøi zápisu
do registrù <tt>coplc</tt>, pokud je DMA copperu zapnuto nebo pokud nainstalovanı program
sám DMA Copperu zapne zápisem do <tt>dmacon</tt> registru. Scanner procházi copperlisty
a ovìøuje všechny move instrukce aplikováním omezení zpùsobenıch Snoop volbou.
Skip a Wait instrukce budou ignorovány.
Pokud scanner objeví ilegální pøístup, program bude ukonèen s chybovou hláškou.
Scanner následuje branche (<tt>copjmp</tt>), detekuje smyèky a zkouší a 16 sublistù.
Pohyby v copperlistech budou uloeny do interního bufferu pro custom registry a ten
bude vypsán do souboru pøi exitu. Scanner není aktivní pøi Fast Snoop módu.

<h4>Kontrola audio ukazatele</h4>
Kdy je aktivovaná volba <a href="opt.html#ChkAudPt">ChkAudPt/S</a>, WHDLoad
bude kontrolovat, zda nainstalovanı program zapisuje pouze správné adresy
do ukazatelù pro Custom DMA zvuku. Správné znamená, e ukazatel se musí
nacházet uvnitø BaseMem a mít jinou hodnotu ne 0. Kontrolovány jsou pouze
zápisove operace longword adres, ne word adres. Tato kontrola mùe bıt
uiteèná pro hledání problémù v rutinách pro pøehrávání zvuku.

<h4>Zkouška Blitter Priority</h4>
Kdy je volba <a href="opt.html#ChkBltHog">ChkBltHog/S</a> aktivována, WHDLoad otestuje, zda instalovanı program
nezapíná BltHog bit zapsáním do dmacon registru. Priorita blitteru mùe zpùsobit
problémy na nìkterıch konfiguracích v souvislosti s rozsáhlımi operacemi pøes blitter
(pouití všech kanálù).
<h4>Test velikosti blitter bloku</h4>
Kdy je volba <a href="opt.html#ChkBltSize">ChkBltSize/S</a> aktivována, WHDlaod otestuje, zda práce blitteru
nepøistupuje mimo vyhrazenou pamì. Pøi zápisu do <tt>bltsize</tt> nebo <tt>bltsizh</tt>
zkouší, jestli je zapnut øádkovı mód - pokud ano, nebude WHDLoad zkoušet velikost bloku.
Jinak vypoèítá WHDLoad první a poslední word pro kadı aktivovanı DMA kanál. Pokud
je adresa mimo BaseMem území, program bude ukonèen s requesterem. Kalkulace je navrena
k práci se všemi módy (ascending/descending, positive/negative modulos, odd
 modulos/ukazatele).
<br>Buïte si vìdomi toho, e øádkovı mód nebude ovìøován a e všechny blitter registry
 mohou bıt zapsány také copperem, pokud je tak nastaven <tt>copcon</tt>.
<h4>Blitter Wait test</h4>
Pokud je volba <a href="opt.html#ChkBltWait">ChkBltWait/S</a> zapnuta, WHDLoad bude sledovat instrukce, aby ovìøil,
e nainstalovanı program korektnì èeká na konec blitter operace ne zaène novou.
Pouívá interní hodnotu, která reprezentuje status další blitter operace.
Hodnota je nastavena pøi zápisu do <tt>bltsize</tt> nebo <tt>bltsizh</tt>
a vymazána, kdy je èten <tt>dmaconr</tt> registr. Pøi kadém kontrolovaném zápisu
je hodnota testována a pokud je zjištìno, e pøedchozí blitter operace stále
bìí, program bude ukonèen s chybovım registrem s adresou neukonèeného blitter
procesu.
<br>Jsou tu ale dva nedostatky: pouití blitteru pøes copperlist není testováno
a pouití blitter pøerušení zpùsobí, e testovací rutina hlásí zbyteèné chyby.
<h4>Kontrola Color Burst</h4>
Kdy je aktivovaná volba <a href="opt.html#ChkColBst">ChkColBst/S</a>, WHDLoad
kontroluje, zda na kadém zápisu do <code>custom.bplcon0</code> registru
je nastaven <code>color</code> bit. Nìkterı hardware, obzvláštì flickerfixer
poaduje, aby byl tento bit nastaven na 1 pro správnı vıstup video signálu.
Pro nejlepší kompatibilitu by mìl bıt tento bit vdy nastaven správnì.
Jsou kontrolovány pøímé zápisy do <code>custom.bplcon0</code> a zápisy
skrze copperlisty.
<h4>Ovládání kontroly Copperu</h4>
Kdy je zapnutá volba <a href="opt.html#ChkCopCon">ChkCopCon/S</a>, WHDLoad
kontroluje, pokud je pøi kadém zápisu do registru <code>custom.copcon</code>,
není bit #1. Tento bit zapíná schopnost Copperu zapisovat do Blitter registrù.
Mùe bıt nìkdy uiteèné detekovat, zda programy pouívají Copper pro ovládání
DMA aktivit.
<h4>Budoucnost</h4>
Plánuje se implementovat schopnosti jako Freezing nebo ikonifikace. Pro tohle
bude Snooping nutnost. Autorùm instalaèek se doporuèuje zkoušet jejich produkty
se Snoop pro budoucí kompatibilitu.
<h4>Poadavky</h4>
Pro Snoop mód je vyadováno vlastnit MMU, se kterım umí WHDLoad pracovat
(na 68030 je ho tøeba zapnout)
<h4>Omezeni</h4>
<ul>
<li>68020 + 68851
<ul>
<li>tento hardware není podporován
</ul>
<li>68030
<ul>
<li>read-modify-write pøístupy do CIA registrù nejsou detekovány
</ul>
<li>68040
<ul>
<li>read-modify-write zápisy do CIA registrù nejsou detekovány
<li><tt>movem</tt> instrukce na ètení pamìti mohou pøistupovat k nesprávnım custom registrùm
bez vytvoøení vyjímky access fault, to se dìje protoe jen první zápis bude ovìøen
pro ovìøení správného registru
<li>instrukce nesmí pøistupovat k víc ne jednomu sledovanému registru najednou,
to znamená, e kód jako <tt>move.b ($dff006),($bfd800)</tt> nemùe bıt
ovládán. Pokud se objeví takovı kód, WHDLoad vyhodí hlášení Access Fault.
</ul>
<li>68060
<ul>
<li><tt>movem</tt> instrukce mohou zasahovat nesprávnı registr bez chybového
hlášení (protoe je testován jen první pøístup)
<li><tt>move &lt;CIA/Custom registr&gt;,sr</tt> bude vykonán nesprávnì, pokud
se snaí zmìnit supervisor portion stavového registru, nezmìní se.
<li>any <tt>(ssp)+</tt> or <tt>-(ssp)</tt> ve spojení s write pøístupem k
CIA nebo Custom registru nemùe bıt pøevzato kvùli problémùm se stackframes,
WHDLoad takove pøístupy detekuje a vyskoèí s pøíslušnım requesterem.
<li>instrukce nesmi pøistupovat víc ne do jednoho støeeného registru najednou,
to znamená, e kód jako <tt>move.b ($dff006),($bfd800)</tt> nemùe bıt zvládnutı
a zpùsobí chybu Access Fault.
</ul>
</ul>
</BODY>
</HTML>
