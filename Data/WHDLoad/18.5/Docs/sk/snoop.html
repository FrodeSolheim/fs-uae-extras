<HTML>
<HEAD>
<TITLE>Snooping (Pátranie)</TITLE>
<meta name="DC.Language" content="sk">
<meta http-equiv="content-language" content="sk">
<meta http-equiv="content-type" content="text/html; charset=windows-1250">
<!-- $Id: snoop.html 1.1 2005/10/31 20:00:57 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Snooping (Pátranie)</h3>
<h4>Èo to vlastne je</h4>
Snooping (pátranie) je vlastnos programu
WHDLoad, ktorá je schopná kontrolova a zaznamenáva prístupy ku custom
a cia registrom. Ak je <a href="opt.html#Snoop">Snoop</a> aktivovanı,
všetky nesprávne prístupy vytvoria Access Fault a nainštalovanı program bude
ukonèenı. Nesprávne prístupy sú:
<ul>
<li>prístupy k neexistujúcim registrom
<li>read prístupy k Write Only registrom
<li>write prístupy k Read Only registrom
<li>prístup do registrov typu Early Read
<li>byte write prístupy (okrem <tt>bltcon0l</tt> a <tt>aud*vol+1</tt>)
</ul>
Strobe registre môu by èítané alebo
zapisované. Custom registre sa odlišujú - OCS (Old ChipSet - A500, A1000, stará
A2000), ECS (Enhanced ChipSet - A600, nová A2000, A3000) a AGA (Advanced
Graphics - A1200, A4000). Take sa táto funkcia hodí hlavne pre h¾adanie chıb v
starıch programoch, ktoré sú spôsobené zlım prístupom k AGA registrom.
<h4>Ako to pracuje</h4>
Ak je snooping zapnutı, WHDLoad oznaèí adresy
custom a cia registrov v MMU translation tree ako neplatné. Vïaka tomu
kadı prístup do custom a cia registrov vyústi do Access Fault vınimky.
WHDload túto vınimku zachytí a môe tak zisti, èi je prístup správny
alebo nie (pri nesprávnom prístupe je program ukonèenı). Zachytenı správny
prístup typu read bude emulovanı a program bude pokraèova, v prípade
platného prístupu typu write, WHDLoad si naviac zapíše hodnotu do vnútorného
zásobníku.<br>
Kvôli preaeniu vınimiek a emulaènej sekvencie sa chod programu znaène
spomalí. Miera spomalenia záleí na CPU, na type Chip RAM (16/32-bit) a na
Stackpointer aligment, ak je Chip RAM 32-bit (buï LongWord aligned alebo nie).
Líši sa to i pod¾a druhu prístupu (Byte/Word/LongWord, Read/Write). Na 68030 sú
zápisy rıchlejšie ne èítanie (pretoe pri èítaní je stackframe 92 bajtov, pri
zapisovaní 32), na 68060 je to naopak, pretoe emulácia zápisu je zloitejšia.
Zapisovanie je viac zloitejšie.

<h4>Rıchly (Fast) Snoop mód</h4>
Vo¾ba <a href="opt.html#Snoop">Snoop/S</a> zapína rıchle pátranie. Read prístupy nebudú testované. iadne
špeciálne testovanie tie neprebieha. Tento mód je uitoènı len na získanie
obsahu custom registru, napr. kvôli uloeniu obrázku pomocou <a href="sp.html">SP</a>.

<h4>Copper List Scanner</h4>
Od verzie 13 sú testované tie copperlisty.
Skener bude aktivovanı pri zápise do registru coplc, ak je DMA copper povolené,
alebo ak nainštalovanı program zapne copper DMA zapísaním <tt>dmacon</tt> registru. Scanner
nasleduje copperlist a validizuje všetky move inštrukcie aplikovaním obmedzenia
spôsobeného Snoop vo¾bou (OCS/ECS/AGA).
Inštrukcie Skip a Wait (okrem CEND) budú ignorované. Pokia¾ budú nájdené nesprávne vstupy, nainštalovanı program bude ukonèenı.
Scanner preh¾adáva vetvy (<tt>copjmp</tt>), zisuje sluèky a kontroluje a do 16ho podlistu.
Inštrukcie Move v copperliste budú uloené do vnútorného custom registra, ktorı bude dumpovanı pri ukonèení WHDLoad.
Scanner je aktívny aj pri Rıchlom Snoop móde.

<h4>Test priority Blitter-u</h4>
Keï je vo¾ba ChkBltHog/S aktivovaná, WHDLoad
testuje, èi nainštalovanı program nezapína BltHog bit zapísaním do dmacon
registru. Priorita blitteru môe spôsobi problémy na niektorıch konfiguráciách
v súvislosti s rozsiahlymi operáciami cez blitter (pouitie všetkıch kanálov).

<h4>Test ve¾kosti blitter bloku</h4>
Keï je vo¾ba ChkBltSize/S aktivovaná, WHDLoad
otestuje, èi práca blitteru nepristupuje mimo vyhradenú BaseMem pamä. Pri
zápise do <tt>bltsize</tt>, alebo do <tt>bltsizh</tt>
skontroluje, èi je zapnutı Line mód v <tt>bltcon1</tt>,
ak áno, WHDLoad nebude testova ve¾kos bloku. Inak WHDLoad vypoèíta prvı a poslednı
word pre prístup k jednotlivım aktivovanım DMA kanálom. Ak je jedna adresa
mimo oblasti BaseMem, program bude ukonèenı s hlásením. Kalkulácia je
navrhnutá, aby pracovala práci so všetkımi módmi (vzostupnı/zostupnı,
pozitívny/negatívny modulos, nepárne modulos/pointers).

<br>Pamätajte, e line drawing mód nebude
kontrolovanı a tak všetky blitter registre môu by taktie zapísané
pomocou copper (ak je nastavenı <tt>copcon</tt>).

<h4>Kontrola Blitter Wait</h4>
Ak je vo¾ba ChkBltWait/S zapnutá, WHDLoad bude
testova inštrukcie, aby overil, e nainštalovanı program správne èaká na
koniec blitter operácie, ne zaène novú. Pouíva sa interná hodnota, ktorá
reprezentuje status blitter operácie. Hodnota sa nastaví, ak sa objaví write
prístup do <tt>bltsize</tt>, alebo
do <tt>bltsizh</tt>. Hodnota sa vymae pri read prístupe do <tt>dmaconr</tt>.
registru. Pri kadom zápise do blitter registru sa skontroluje interná premenná a ak sa
zistí, e blitter pracuje, program bude ukonèenı a WHDLoad zahlási PC
posledného neukonèeného blitter procesu spolu s jeho adresou. <br>
Sú tu ale dva nedostatky: pouitie blitteru cez copperlist nie je kontrolované
a pouitie blitter prerušení spôsobí, e kontrolná rutina hlási zbytoèné chyby.

<h4>Plány do budúcnosti</h4>
Plánujem implementova vlastnosti ako Freezing, and Iconify.
Pre tieto dve je Snoop ideálny. Preto doporuèujem autorom inštalaèiek, aby si skontrolovali ich inštalácie
pre kompatibilitu so Snoopom - èím zaistia aj kompatibilitu s budúcimi verziami WHDLoad.
<h4>Poiadavky</h4>
Pre Snoop je potrebné MMU. WHDLoad musí <a href="mmu.html#usercontrol">pouíva</a> MMU, prípadne
<a href="opt.html#MMU">MMU/S</a> musí by zapnuté na 68030.
<h4>Obmedzenia</h4>
<ul>
<li>68020 + 68851
<ul>
<li>momentálne nepodporovanı hardvér
</ul>
<li>68030
<ul>
<li>iadne známe obmedzenia
</ul>
<li>68040
<ul>
<li>momentálne nepodporovanı hardvér
</ul>
<li>68060
<ul>
<li>Inštrukcia <tt>movem</tt> môe pristupova do nesprávneho registra bez vytvorenia vınimky
Access Fault, toto sa môe sta, pretoe je kontrolovanı len prvı prístup do registru.
<li>Inštrukcia <tt>move &lt;Cia/Custom register&gt;,sr</tt> bude vykonaná nesprávne,
pokia¾ sa bude snai zmeni èas Supervisor status registru. Táto zmena však nebude vykonaná
<li>Inštrukcia <tt>(ssp)+</tt> alebo <tt>-(ssp)</tt> v súèinnosti so zápisom do Cia alebo Custom registru
nemôe by spracovaná kvôli problémom so stackframe. WHDLoad tento prístup zachytí a ukonèí program s príslušnım hlásením.
<li>Inštrukcia nesmie prsistupova k viac ako jednému Snoopovanému registru naraz. To znamená, e napr.: <tt>move.b ($dff006),($bfd800)</tt>
nemôe by spracovaná. Ak sa to však udeje, WHDLoad oznámi chybu Access Fault</ul>
</ul>
</BODY>
</HTML>
