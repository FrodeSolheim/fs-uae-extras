<HTML>
<HEAD>
<TITLE>Ovládanie CPU Cache</TITLE>
<meta name="DC.Language" content="sk">
<meta http-equiv="content-language" content="sk">
<meta http-equiv="content-type" content="text/html; charset=windows-1250">
<!-- $Id: cache.html 1.4 2014/12/04 23:37:38 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Preh¾ad CPU Cache </h3>
Niektoré procesory z radu 68k sú schopné
pouíva cache poèas prístupu k pamäti, èo zlepšuje vıkon.<br>
Na cache sa vdy odkazuje pomocou logickıch adries, vrátane funkèného kódu pre
prístup. To znamená, e prístupy v Uívate¾skom móde a Supervisor móde budú
vytvára odlišné cache poloky do (pre viac informácií si preštudujte
dokumentáciu od Motoroly).
<p>Nasleduje preh¾ad CPU 68k:
<ul><li>68000
iadna
<li>68010<ul>
<li>Instruction Prefetch
<br>dvojwordovı prefetch, jednowordovı dekódovací register
<li>Loop Mode
<br>vzniká, ak je jednowordová inštrukcia nasledovaná DBcc, iadna ïalšia inštrukcia sa u neobjaví, kım sa cyklus neskonèí
</ul><li>68020<ul>
<li>Instruction Prefetch
<br>jeden longword
<li>Instruction Cache
<br>16 lines á 16 byte = 256 bytes
<br>môe by aktivovaná alebo vypnutá cez CACR
</ul><li>68030<ul>
<li>Instruction Prefetch
<br>jeden longword
<li>Instruction Cache
<br>16 lines á 16 byte = 256 bytes
<br>mmôe by aktivovaná alebo vypnutá cez CACR
<li>Data Cache
<br>16 lines á 16 byte = 256 bytes
<br>môe by aktivovaná alebo vypnutá cez CACR
<br>vdy WriteThrough
<br>volite¾nı Write Allocation mód
</ul><li>68040<ul>
<li>Instruction Prefetch
<br>jeden longword
<li>Instruction Cache
<br>256 lines á 16 byte = 4096 bytes
<br>môe by aktivovaná cez CACR
<li>Data Cache
<br>256 lines á 16 byte = 4096 bytes
<br>môe by aktivovaná cez CACR
<br>volite¾né módy CopyBack/WriteThrough cez MMU
</ul><li>68060<ul>
<li>Instruction Prefetch
<br>jeden longword
<li>Instruction Cache
<br>512 lines á 16 byte = 8192 bytes
<br>môe by aktivovaná, vypnutá alebo redukovaná na polovicu cez CACR
<li>Branch Cache
<br>môe by aktivovaná cez CACR
<br>nie je ovplyvnite¾ná cez MMU setup!
<li>Superscalar Dispatch
<br>môe by aktivovaná cez CACR
<li>Data Cache
<br>512 lines á 16 byte = 8192 bytes
<br>môe by aktivovaná, vypnutá alebo redukovaná na polovicu cez CACR
<br>volite¾né módy CopyBack/WriteThrough cez MMU
<li>Push Buffer
<br>môe by vypnutá cez PCR
<li>Store Buffer
<br>môe by aktivovaná cez CACR
<br>Stránky nesmú by nastavené ako NonCachable Serialized (precise)
</ul></ul>
<h4><a name="cache">Manaovanie Cache vo WHDLoad</a></h4>
Prvou dôleitou vecou je pochopenie, e cache na 68030..68060 je ovládaná
cez Cache Control Register (CACR) <b>a</b> MMU (za
predpokladu, e WHDLoad pouíva a ovláda MMU)!
<br>V CACR budú Cache globálne zapnuté alebo vypnuté. Pouívaním stránkovania MMU
(4 KBytes s WHDLoad) bude urèené, ako majú pracova. <br>
Na 68030 môe by pamäová stránka Cacheable alebo NotCacheable. Na 68040/68060
môe by Cachable WriteThrough, cachable CopyBack, NonCachable (imprecise)
alebo NonCachable Serialized (precise).
Ak WHDLoad nepouíva MMU, ovláda cache len CACR.
<h4>Štandardné nastavenie Cache</h4>
Štandartne sú oblasti programu WHDLoad, Slave a ExpMem oznaèené ako Cachable CopyBack.
BaseMem oblas je oznaèená ako NonCachable a dátová a inštrukèná Cache sú zapnuté v CACR.
Take program v BaseMem oblasti beí bez Cache, ale WHDLoad a Slave pouívajú Cache
na dosiahnutie najlepšieho vıkonu.
<h4>Kontrola Cache programátorom</h4>
Existujú dve resload funkcie na ovládanie Cache a to:
<A HREF="../autodoc.html#resload_SetCACR">resload_SetCACR</a> a <A
HREF="../autodoc.html#resload_SetCPU">resload_SetCPU</a>. Resload_SetCACR je historicky staršia
rutina a <a href="../autodoc.html#resload_SetCPU">resload_SetCPU</a> ju môe plne nahradi. (WHDLoad interne mapuje argumenty <a href="../autodoc.html#resload_SetCACR">resload_SetCACR</a>
a volá <a href="../autodoc.html#resload_SetCPU">resload_SetCPU</a>). Kadopádne, pouitie <a href="../autodoc.html#resload_SetCACR">resload_SetCACR</a> sa doporuèuje pre všetkıch, ktorí
toho o správaní cache príliš nevedia. Pouívaním <a href="../autodoc.html#resload_SetCACR">resload_SetCACR</a> môu by jednotlivo vypnuté
alebo zapnuté inštrukèné a dátové cache. Resload_SetCACR ovplyvòuje len schopnos pouíva
Cache BaseMem oblasti.

<h4>Kontrola Cache uívate¾om</h4>
Ak programátor odviedol dobrú prácu, uívate¾ sa nemusí o cache vôbec stara,
pretoe všetko zariadi nastavenie Slave.
<br>Môu sa však vyskytnú dva dôvody na zmenu nastavenia cache. Prvım je spojazdnenie
inštalaèky, ktorá má nejaké problémy, pretoe beí príliš rıchlo (napr. grafické chyby)
a druhım je urıchlenie nainštalovaného programu.
<p>Na spojazdnenie inštalaèky môe by pouitá vo¾ba
<a href="opt.html#NoCache">NoCache</a>. Táto vo¾ba vypne všetky Cache a oznaèí pamä ako NonCachable Serialized.
Ak má ale stroj 32-bitovú Chip RAM, bude ešte stále rıchlejší ne pôvodná A500.

<p>Na urıchlenie programu môete nastavi niektoré vo¾by, ktoré cache zapnú. Tie majú väèšiu prioritu ako
nastavenie v Slave. Na 68020 môe by pouitá vo¾ba <a href="opt.html#Cache">Cache</a>. Pre CPU 68030 je urèená vo¾ba
<a href="opt.html#DCache">DCache</a> ktorá je u ale obsiahnutá vo vo¾be <a href="opt.html#Cache">Cache</a>
Pre 68060 existuje viac volieb: <a href="opt.html#BranchCache">BranchCache</a>,
<a href="opt.html#StoreBuffer">StoreBuffer</a> a
<a href="opt.html#SuperScalar">SuperScalar</a>. Vo¾ba <a
href="opt.html#ChipNoCache">ChipNoCache/S</a> môe vylepši vıkon na 68040 a 68060, pozri nišie.
<a name="chipmem"></a><h4>Pouitie Cache na pamä typu Chip</h4>
Pouitie cache nemusí by zapnuté len samotnım
procesorom (CACR) a nastavením MMU, ale i externım hardvérom. CPU na
zbernici signalizuje, e sa pokúša poui cache na prístupy. A externı hardvér
môe odpoveda (po tom, ako adresa bola poèas pamäového prístupu vloená
do adresy zbernice), e na tento prístup sa chache nesmie poui. Tento
mechanizmus, kedy hardvér pre CPU signalizuje, èi sa na danú pamä dá poui cache
alebo nie, je pod¾a mojich znalostí pouitı na všetkıch Amigách a doskách
s procesorom 68030 a vyšším (pretoe tie majú dátovú cache).
Ovplyvnená je celá Chip pamä a IO-Space (CIA/Custom/RTC), na ktorı však
nesmie by pouitá dátová cache. Toto je dôleite kvôli vyvarovaniu sa cache
nekozistencii, napríklad kvôli aktivite DMA.
<br>Ak hardvér odmietne pouitie cache, reakcia
procesoru je rôzna v závislosti na CPU. Na 68030 sa to neodrazí vo
vıkonnosti, na dáta jednoducho nebude pouitá cache. Na 68040 prístupy typu
read budú vykonávané v plnej rıchlosti, zatia¾ èo write prístupy
(CopyBack) budú zrušené a reštartované bez pouitia cache. To sa prejaví
pribline pänásobnım spomalením rıchlosti (závisí to na hardvéri
a rıchlosti CPU). Na 68060 budú zrušené a reštartované oba druhy
prístupov. Èítanie sa spomalí trikrát a zapisovanie päkrát.
<br>Spomenuté poznámky majú vzah k dátovej
cache. Inštrukèné prístupy sú tımto procesom zvyèajne nedotknuté a je na
ne moné poui cache i v rámci Chip pamäte. Existuje však hardvér
(pravdepodobne vadnı), ktorı to nedovo¾uje. Potom treba poui vo¾bu <a
href="../en/opt.html#ChipNoCache">ChipNoCache/S</a>, pomocou ktorej sa vyhneme
vıraznému spomaleniu chodu programu. V opaènom prípade budú inštrukèné
prístupy dvakrát pomalšie.
<p>Toto správanie si môete preveri spustením <i>Speed.Slave</i>,
ktorı sa nachádza v src/memory-speed adresári v developerskom archíve.
<h4>Write Allocation</h4>
Write Allocation kontroluje ovládanie cache na
68030, keï sa prihodí zlyhanie cache pri zápise. Write Allocation musí by
zapnutá, keï èasti nainštalovaného programu beia v Uívate¾skom móde. Ak
nainštalovanı program beí v Supervisor móde, môe by Write Allocation
vypnutá, èo poskytne jemné zvıšenie vıkonu.
<h4>Branch Cache</h4>
Branch Cache je dostupná len na 68060. Je to druh inštrukènej
Cache pre Branch inštrukcie. Ale na rozdiel od inštrukènej Cache však nie je
ovplyvnite¾ná cez nastavenie MMU! To znamená, e i keï je zodpovedajúca stránka
pamäte oznaèená ako NonCachable, na Branch inštrukcie bude vdy pouitá cache
(ak je Branch Cache zapnutá).
<p><hr>Preèítajte si Motorola Microprocessors User
Manuals pre ïalšie informácie. Ak máte pripomienky, èo sa tıka tejto stránky,
prosím píšte na <a href="mailto:wepl@whdload.de">e-mail</a>.
<p><b>Prípadné nejasnosti najprv konzultujte
s anglickım originálom. To platí pre väèšinu odbornıch statí tejto dokumentácie.</b></p>
</BODY>
</HTML>
