<HTML>
<HEAD>
<TITLE>Programovanie WHDLoad</TITLE>
<meta name="DC.Language" content="sk">
<meta http-equiv="content-language" content="sk">
<meta http-equiv="content-type" content="text/html; charset=windows-1250">
<!-- $Id: howto.html 1.2 2009/02/05 20:38:15 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Schematické zobrazenie postupu po spustení programu WHDLoad</h3>
Nasledujúca tabu¾ka ukazuje, ako pracuje program WHDLoad, keï
je spustenı nainštalovanı program. Dúfam, e to pomôe pri pochopení, ako
WHDLoad pracuje a ako WHDLoad, Slave a nainštalovanı program spolupracujú.
<p>
<table cellpadding=3>
  <tr>
    <td valign=top>Uívate¾</td>
    <td>
      <ul>
        <li>spustí demo alebo hru kliknutím na ikonu alebo spustením WHDLoad cez príkazovı riadok
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>Operaènı Systém</td>
    <td valign=top>
      <ul>
        <li>nahrá executable programu WHDLoad a spustí ho
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>WHDLoad</td>
    <td>
      <ul>
        <li>testuje softverové a hardverové prostredie
        <li>nahrá a testuje Slave
        <li>alokuje poadovanú pamä pre program
        <li>ak je zapnutı <a href="opt.html#Preload">Preload/S</a>, nahráva obraz disku alebo súbory do RAM (ak je pre ne dostatok vo¾nej pamäte)
        <li>vypína OS (zastaví multitasking a
       prerušenia, degraduje grafickı hardvér na OCS, inicializuje všetok
       hardvér s definovanımi hodnotami)
        <li>skoèí do kódu Slave
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>Slave</td>
    <td>
      <ul>
        <li>nahrá hlavnı executable nainštalovaného
       programu volaním WHDLoad funkcie (napr. <a
       href="../autodoc.html#resload_DiskLoad">resload_DiskLoad</a>,alebo <a
       href="../autodoc.html#resload_LoadFile">resload_LoadFile</a>)
        <li>upraví hlavnı executable (take program
       bude nahráva svoje dáta cez Slave, odstránia sa problémy
       s nekompatibilitou a je umonené vyskoèenie z programu),
	   prípadne nastaví exit key - klávesu, prostredníctvom ktorej sa môeme vráti do OS)
        <li>skoèí do hlavného executable hry alebo dema
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>Nainštalovanı program</td>
    <td>
      <ul>
        <li>robí to, na èo bol programovanı ;-)
        <li>pri nahrávaní dát z disku volá Slave
       (pretoe Slave ho predtım tak upravil) a Slave volá WHDLoad a WHDLoad
       èiastoène zapne OS, aby nahral dáta z disku (ak dáta neboli
       nahrané predtım pomocou vo¾by <a href="opt.html#Preload">Preload</a>),
       potom sa vráti z OS, vráti sa z WHDLoad, vráti sa zo Slave a
       nainštalovanı program pokraèuje ïalej
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>Uívate¾</td>
    <td>
      <ul>
        <li>ukonèí program pomocou klávesy <a href="opt.html#QuitKey">QuitKey</a>
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>Slave</td>
    <td>
      <ul>
        <li><span lang=SK>vracia sa do WHDLoad volaním <a href="../autodoc.html#resload_Abort">resload_Abort</a>
      </ul>
    </td>
  </tr>
  <tr>
    <td valign=top>WHDLoad</td>
    <td>
      <ul>
        <li>odblokuje OS (vráti hodnoty hardvér registru, displeja a pamäte)
        <li>uvolní všetky alokované zdroje
        <li>vracia sa do OS
      </ul>
    </td>
  </tr>
</table>
<h3>Ako vytvori jednoduchı trackloader jedno-disketovej hry</h3>
Toto je len ve¾mi malı a krátky názornı
príklad, ako vytvori inštalaèku pomocou programu WHDLoad. Ukáka popisuje
najjednoduchšiu situáciu, s ktorou sa však v skutoènosti (pravdepodobne) nikdy nestretnete,
take pre špeciálne prípady a problémy, ktoré môu nasta, èítajte
ïalšie kapitoly.
<ol>
  <li>Príprava
    <ul>
      <li>Vytvorte adresár, kde budú uloené všetky súbory.
      <li>Vytvorte disk image pomocou <a href="dic.html">DIC </a>a presuòte ho do nášho adresára.
      <li>Vytvorte <a href="opt.html#optwb">ikonu</a>
      s &quot;WHDLoad&quot; ako &lt;Default Tool&gt; a tooltype
      &quot;SLAVE=#?&quot; obsahujúcim meno Slave (alebo jednoducho
      prekopírujte ikonu z ukákovıch inštalácií a odstráòte všetky tooltype
      okrem &quot;SLAVE=&quot;
    </ul>
  <li>Slave<br>
    Na napísanie Slave potrebujeme nasledujúce informácie:
    <ol>
      <li>Kde je na disku hlavnı executable?
      <li>Kde je vo vnútri hlavného executable disk-loader? (tj. nahrávacia rutina)
    </ol>
	Na získanie tıchto
informácii najskôr analyzujeme bootblock. Väèšinou je executable nahranı
pomocou funkcie exec.DoIO(), niekedy je ale v bootblocku špeciálny trackloader.
Napíšeme Slave, ktorı simuluje bootblock a nahrá hlavnı executable z disk
image. Teraz získame (vyripujeme) hlavnı executable z image alebo <a
href="dump.html#memory">memory dump</a>, Potom musíme nájs loader v hlavnom
executable. Rıchlou cestou je pomocou hex-editoru h¾ada reazec $AAAAAAAA
(ktorı je pouívanı pre MFM dekódovanie). Potom vystrihneme danú oblas (+/-
$1000 bytes), disassemblujeme ju a nájdeme zaèiatok rutiny. Musíme pochopi
zoznam parametrov. Potom vytvoríme kód pre Slave, ktorı upraví túto loader
rutinu tak, e všetky odkazy na loader budú presmerované do Slave. Potom si
Slave prispôsobí parametre a zavolá WHDLoad funkciu <a
href="../autodoc.html#resload_DiskLoad">resload_DiskLoad</a>.
  <li>V ideálnom prípade je inštalaèka hotová.<br>
     Zostáva u len urobi peknú ikonu. Extrahujte dva obrázky
     pouitím <a href="snoop.html">snoop módu</a> a <a href="sp.html">SP</a> alebo
     freezerom alebo U.A.E. a vytvorte ikonu. Doporuèená je šestnásfarebná <a
     href="ftp://ftp.wustl.edu/pub/aminet/pix/mwb/RomIcons10.lha">RomIcon</a>
     paleta.

</ol>
<h3>Moné problémy a zvláštne prípady</h3>
<h4>Neštandardnı trackloader</h4>
Niektoré programy majú svoj vlastnı formát
disku. To znamená, e <a href="dic.html">DIC</a> nemôe vytvori disk image. Na
vytvorenie súboru alebo image z takého disku je potrebné napísa špeciálnu
rutinu s pouitím <a href="rawdic.html">RawDIC</a>. Pre viac informácií èítajte
dokumentáciu RawDIC.
<h4>Viacero diskov</h4>
Ak program pouíva viac ne jednu disketu,
Slave musí presmerova prístupy k disku na zodpovedajúci disk image súbor.
Niekedy je to aké. Niektoré programy vedia poui viac disketovıch jednotiek,
take môete poui èíslo jednotky na vybratie správneho image. Väèšina
programov pouíva urèité ID na kadom disku kvôli rozpoznaniu, v tomto prípade
pouite premennú, ktorá by obsahovala èíslo diskety a pri kadom prístupe
na ID diskety (odha¾te také prístupy analyzovaním parametrov pre disk loader)
zvıšte hodnotu premennej (ak sa dostaneme na poslednú disketu, zníte hodnotu).
Tak by mal loader èíta ID znova a znova, a kım nenájde správnu disketu.
Ak sa zobrazuje poiadavka na vloenie disku, odstráòte ju.
<h4>Ukladanie Highscore tabu¾ky</h4>
Pouite <a href="../autodoc.html#resload_SaveFile">resload_SaveFile</a>
na zapísanie potrebnej oblasti pamäte na disk. Ak chcete, zašifrujte vytvorenı
súbor, take lameri ho nebudú schopní tak ¾ahko editova. Nie je dobré
zapisova highscore priamo do disk image (pouitím <a
href="../autodoc.html#resload_SaveFileOffset">resload_SaveFileOffset</a>), pretoe ak sa
nieèo zlé prihodí (napr. program zamrzne), môe sa sta, e image sa poškodí.
<h4>Uloenie pozície v hre (Savegames)</h4>
Ovládanie je rovnaké, ako pri ukladaní highscore.
<h4>Prístupy do operaèného systému</h4>
V momente, kedy je Slave a inštalovanı program
v chode, neexistuje iadny OS, take iadny prístup k nemu nebude fungova!
Všetky prístupy nainštalovaného programu k OS musia by odstránené alebo
emulované. Ak ich nie je príliš ve¾a a nemajú pre WHDLoad systému ve¾kı vıznam
(napr. exec.Disable() alebo exec.SuperState()) jednoducho ich odstráòte pomocou
NOP ($4e71). Ak má volanie OS dôleitú funkciu (ako exec.DoIO()), presmerujte
toto volanie do Slave a emulujte ho. Ak ich je takıchto prístupov mnoho,
vytvorte jednoduchú exec.library v nepouitej oblasti pamäte (iniciujte
longword adresu na <tt>$4</tt>). Môete sa
pozrie napr. na Oscar.slave, ktorı emuluje exec.AllocMem(). Na zistenie
prístupov do OS, zaèiatok execbase je nastavenı na $f0000001 kvôli tomu, pretoe
všetky rutiny, ktoré pouijú execbase, spôsobia vınimku &quot;Address
Error&quot;.<br>
Ak je prístupov do OS a príliš mnoho, pouite jeden z KickEmu balíèkov z
whdload-dev archívu. Je tam jeden balíèek pre Kick 1.3
('src/sources/whdload/kick13.s') a jeden pre Kick 3.1
('src/sources/whdload/kick31.s'). Tieto balíèky vyadujú originálny kickstart
ROM súbor a vytvoria kompletné OS prostredie vo vnútri WHDLoad. Pre viac
informácií si preèítajte priloené ReadMe.
<h3>Obvyklé problémy s kompatibilitou</h3>
<h4>Obmedzenı adresnı priestor na 68000/68010/68ec020 procesoroch</h4>
Na tıchto procesoroch je adresnı priestor limitovanı na 16 MB (<tt>$000000...$ffffff</tt>), pretoe tieto procesory majú len 24 adresnıch riadkov. Následkom
toho všetky prístupy na vyššie adresy sú vykonané na niších 16 MB ignorovaním
väèšiny signifikantnıch 8 bitov. Niektoré programy pouívajú tieto bity na
ukladanie dát alebo ich jednoducho zabudnú vyèisti. Na procesoroch
s plnım 4 GB adresovaním (68020/680ec30/68030/68040/68060) toto nebude
fungova, pretoe je sprístupnené plné 32 bitové adresovanie. Na vyriešenie
tohto problému treba upravi tieto prístupy a presmerova ich na príslušnú
adresu. Niekedy príèina pristupovania na zvláštne adresy môe by
neinicializovaním pointeru. V tomto prípade môe pomôc vyèistenie <tt>$400</tt> - <a href="../autodoc.html#ws_BaseMemSize">ws_BaseMemSize</a>.
<h4>Odlišné stackframes na kadom CPU</h4>
Stackframes tvorené CPU prerušeniami a
vınimkami sa u jednotlivıch CPU líšia. Na 68000 je stackframe 6 bajtov, okrem
zbernicovıch a adresovıch chıb. Stackframe obsahuje hodnotu SR na (a7) a
hodnotu PC na (2,a7). Na ostatnıch CPU je minimálny stackframe 8 bajtov a
dodatoène obsahuje èíslo vektoru ako word na (6,a7). Tento štvorwordovı formát
stackframu je vytvorenı pre &quot;Trap #xx&quot; a prerušenie na 68010-68060.
Stackframes pre ostatné vınimky sú na kadom procesore iné. Inštrukcia RTE
funguje inak na 68000 a inak na 68010+. Na 68000 vracia hodnotu do SR a potom
sa vracia na správnu adresu, zatia¾ èo na 68010+ naviac uvo¾ní stackframe pod¾a
adekvátneho stackframe formátu.<br> Niektoré programy posunú adresu a hodnotu SR a
potom vykonajú RTE. Takto to ale funguje len na 68000, na inıch CPU to má
katastrofálne úèinky. Ak sa o to program pokúša, musíte to opravi. Niekedy
staèí nahradi RTE s RTR.
<h4>MOVEM.x RL,-(An) na 68000/010 a 68020/030/040</h4>
Je rozdiel, ak register pouitı v predecrement
móde je tie obsiahnutı v zozname registrov. Pre 68020, 68030 a 68040 je
hodnota zapísaná do pamäti poèiatoènou hodnotou registru zníená o rozsah
operácie. 68000 a 68010 zapisujú poèiatoènú hodnotu registru (nezníenú).<br>Keïe
takáto konštrukcia nie je ve¾mi uitoèná, nie je známy iaden súèasnı software,
ktorı by mal kvôli tomu problémy.
<h3>Hlavné zásady pri vytváraní inštalaèiek</h3>
<ul>
<li>Na novších CPU nemodifikujte CPU registre
     napr. VBR a CACR. Z programátorského poh¾adu je VBR vdy na 0, i keï je
     presunuté, pretoe autovektory (a TRAPs, ak je vo¾ba <a
     href="../autodoc.html#WHDL_EmulTrap">WHDL_EmulTrap</a> zapnutá) sú emulované.
     Bity v CACR sa líšia u kadého CPU. Je len jeden správny spôsob ako
     modifikova caches: pouite funkcie <a href="../autodoc.html">resload_SetCACR/SetCPU</a>
     a bitdef hodnoty z 'exec/execbase.i' a 'whdload.i'. Tie všetok kód v
     programe, ktorı mení tieto registre, musí by odstránenı alebo vynechanı.
<li>Nikdy nemodifikujte disk image, pretoe ak
     by niekto chcel spusti program z diskety, staèí mu len zapísa image spä
     na disk (za predpokladu, e program beí z diskety i bez rôznych opráv, èo
     nie je ve¾mi èastı prípad).
<li>Nikdy nepouívajte originálny kód z programu priamo vo Slave (copyright problém).
<li>Zapnite caches len ak ste si istı, e to bude fungova na všetkıch procesoroch.
<li>Pouívajte èo najmenej pamäte pre
     <a href="../autodoc.html#ws_BaseMemSize">ws_BaseMemSize</a>. Niektorí ¾udia majú rezidentné tagy na konci Chip RAM,
     take pomáha ak pouijete len $1f0000 namiesto $200000 a WHDLoad môe
     poui absolútnu alokovanú pamä.
</ul>
<h3>Tipy a triky</h3>
<h4>Èo je lepšie, pouívanie diskovıch obrazov alebo súborov?</h4>
Niekedy si musíte vybra, èi poui obraz diskety alebo reálne súbory.
Oba spôsoby majú svoje vıhody. Pouitie obrazu je väèšinou ¾ahší
a rıchlejší spôsob ako vytvori Slave. Na druhú stranu, reálne súbory
sa ¾ahšie ukladajú do cache (ak je napr. málo pamäte alebo pamä
je fragmentovaná). Potrebné miesto na harddisku bude menšie pri pouití
reálnych súborov ako pri pouití obrazov. Diskové obrazy by ste mali poui
vtedy, ak zdroj obsahuje väèšie mnostvo súborov (viac ne 30).
</BODY>
</HTML>
