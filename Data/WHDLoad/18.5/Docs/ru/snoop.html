<html>

<head>
<title>Snooping</title>
<meta name="DC.Language" content="ru">
<meta http-equiv="content-language" content="ru">
<meta http-equiv="content-type" content="text/html; charset=windows-1251">
<!-- $Id: snoop.html 1.8 2014/12/04 23:37:38 wepl Exp wepl $ -->
</head>

<body>

<h3>Snooping (слежение)</h3>

<h4>Что это такое</h4>

<p><strong>Snooping</strong> это особенность программы WHDLoad,
позволяющая отслеживать и вести журнал событий,
доступа к регистрам <strong>Cia</strong> и <strong>Custom</strong>.
Если активирован параметр <a href="opt.html#Snoop">Snoop</a>, то
все некорректные обращения создадут Ошибку
Доступа, а установленная программа будет
завершена. WHDLoad выдаст сообщение с причиной сбоя.

<h4>Custom регистры</h4>
Проверяются все попытки чтения и записи custom регистров.
Некорректными являются:
<ul>
  <li>доступы к запрещённым регистрам </li>
  <li><em>чтение</em> регистров, предназначенных только
    для записи (Write Only)</li>
  <li><em>запись</em> в регистры, предназначенных только
    для чтения (Read Only)</li>
  <li>доступ к регистрам Early Read</li>
  <li>попытка записи байта в регистры (за исключением <strong><tt>bltcon0l</tt></strong>
    и <strong><tt>aud*vol+1</tt></strong>) </li>
</ul>

<p>Регистры строба (Strobe) могут быть прочитаны или
записаны. Набор Custom-регистров может изменяется
между OCS (Old ChipSet - A500, A1000, старая A2000), ECS (Enhanced ChipSet -
A600, новая A2000, A3000) и AGA (Advanced Graphics - A1200, A4000). Это
полезно для поиска в старых программах ошибок
из-за обращений к новым регистрам AGA.</p>

<p>
Используя функцию <a href="../autodoc.html#resload_Control">resload_Control</a> 
и тэги <a href="../autodoc.html#WHDLTAG_CUST">WHDLTAG_CUST_DISABLE/READ/STROBE/WRITE</a>
может быть модифицирована внутренняя конфигурация WHDLoad, какие регистры доступны по записи/чтению.
С помощью этого некорректные попытки доступа могут быть проигнорированы, либо могут быть просто замечена все попытки доступа.
Должно использоваться только в процессе тестов, но не в релизных версиях модулей.
</p>

<h4>Cia регистры</h4>У Cia регистров проверяется только доступ по записи.
Это означает, что доступ на чтение для несуществующих регистров в области памяти $bfd000...$bfefff не сможет быть проверен.
Для всех обращений по записи, записанное значение WHDLoad сохранит внутри себя.
Для некоторых Cia регистров существуют специальные проверки, в зависимости от записываемого значения:

<p><table border=1 summary="table of cia registers">
<tr>
	<th>адрес</th>
	<th>регистр</th>
	<th>проверка</th>
</tr><tr>
	<td>$bfe001</td>
	<td>ciaa.ciapra</td>
	<td>запрещена установка Overlay бита #0</td>
</tr><tr>
	<td>$bfe201</td>
	<td>ciaa.ciaddra</td>
	<td>биты #6-7 могут иметь любое значение (используется для игрового манипулятора), младшие биты должны быть	%000011</td>
</tr><tr>
	<td>$bfe801</td>
	<td>ciaa.ciatodlow</td>
	<td rowspan=3>доступы по чтению-изменению-записи (например, bchg) запрещены в случае, если ALARM бит выставлен в ciaa.ciacrb (проверяется только на 68060)</td>
</tr><tr>
	<td>$bfe901</td>
	<td>ciaa.ciatodmid</td>
</tr><tr>
	<td>$bfea01</td>
	<td>ciaa.ciatodhi</td>
</tr><tr>
	<td>$bfed01</td>
	<td>ciaa.ciaicr</td>
	<td>доступы по чтению-изменению-записи (например, bchg) запрещены (проверяется только на 68060)</td>
</tr><tr>
	<td>$bfd100</td>
	<td>ciab.ciaprb</td>
	<td>биты для MOTOR #7, SELECT #3-6 и STEP #0 должны быть очищены, другие биты могут быть изменены; с помощью этого может быть обнаружен любая попытка доступа к флоппи-дисководам</td>
</tr><tr>
	<td>$bfd200</td>
	<td>ciab.ciaddra</td>
	<td>записанное значение должно быть %11000000</td>
</tr><tr>
	<td>$bfd300</td>
	<td>ciab.ciaddrb</td>
	<td>записанное значение должно быть %11111111</td>
</tr><tr>
	<td>$bfd800</td>
	<td>ciab.ciatodlow</td>
	<td rowspan=3>доступы по чтению-изменению-записи (например, bchg) запрещены в случае, если ALARM бит выставлен в ciaa.ciacrb (проверяется только на 68060)</td>
</tr><tr>
	<td>$bfd900</td>
	<td>ciab.ciatodmid</td>
</tr><tr>
	<td>$bfda00</td>
	<td>ciab.ciatodhi</td>
</tr><tr>
	<td>$bfdd00</td>
	<td>ciab.ciaicr</td>
	<td>доступы по чтению-изменению-записи (например, bchg) запрещены (проверяется только на 68060)</td>
</tr></table>


<h4>Как это работает</h4>

<p>Если Snoop включен, WHDLoad отмечает в списке
перевода диспетчера памяти (MMU) адреса Custom и Cia
регистров, как неверные/защищенные по записи. Из-за этого, каждый
доступ к Custom или Cia регистрам закончится
исключением &quot;Ошибка Доступа&quot;. Это
исключение будет взято под управление WHDLoad.
Вначале, он проверяет, что доступ действителен.
Если доступ недействителен, программа будет
закончена. Если доступ действителен и если это
операция чтения, он будет эмулироваться и
выполнение программы продолжится. Если это
операция записи то WHDload дополнительно, сохранит
значение во внутреннем буфере. <br>
Произойдёт замедление выполняемой программы,
так как будут еще обрабатываться исключения и
будет производиться эмуляция. Насколько сильно
замедлится программа, зависит от типа
центрального процессора, типа Chip-памяти (16/32-bit) и
выравнивания указателя стека, если Chip-память 32-х
битная (есть выравнивание по длинным словам или
нет). Это также отличается для типа доступа (байт /
слово / длинное слово, чтение/запись). 68030 пишет,
быстрее чем, читает (потому что чтение, фрейма
стека включает 92 байта, запись - 32 байта), на
процессорах 68060 чтение, быстрее, потому что
эмуляция для записи, более сложная. </p>

<h4>Режим быстрого слежения (Fast Snoop)</h4>

<p>Параметр <a href="opt.html#Snoop">Snoop/S</a> активизирует
режим быстрого слежения. Доступы по чтению
проверяться не будут. Не будет выполняться никаких
специальных проверок. Этот способ может быть
полезен только для получения содержания
Custom-регистров, например, чтобы сделать снимок
экрана, используя <a href="sp.html">SP</a>.</p>

<h4>Сканер Copper List'а</h4>

<p>Начиная с версии 13, WHDLoad также может сканировать
копперлисты (copperlists). Сканер будет активирован на
запись в регистры <strong><tt>coplc</tt></strong>, если активизирован
copper dma, или когда установленная программа активизирует
coppper dma, записывая в регистр<strong><tt> dmacon</tt></strong>.
Сканер следит за копперлистами и подтверждает все
инструкции Move, применяя ограничения, наложенные
опцией Snoop (OCS / ECS / AGA). Инструкции Skip и Wait (за
исключением CEND) будут игнорироваться. Когда он
находит недействительные вхождения,
установленная программа завершается. Сканер
также следит за ответвлениями (<tt>copjmp</tt>),
обнаруживает циклы и проверяет до 16 подсписков.
Инструкции Move в копперлистах будут сохранены во
внутреннем файле регистров, который будет создан
при выходе WHDLoad. Сканер не активен в режиме
быстрого слежения&nbsp; (Fast Snoop). </p>

<h4>Проверка указателя звука</h4>
Когда активирована опция <a href="opt.html#ChkAudPt">ChkAudPt/S</a>, WHDLoad
будет проверять, что установленная программа пытается писать только корректные адреса
в указатели Custom audio DMA.
Корректные, имеется в виду, что указатель должен находиться в BaseMem и не быть равным 0.
Проверяются только долгие операции записи (long write operations).
Операции с Word не проверяются.
Данная проверка может быть полезна для нахождения пробем в подпрограммах воспроизведения звука.

<h4>Проверка приоритета блиттера</h4>

<p>Когда активирована опция <a href="opt.html#ChkBltHog">ChkBltHog/S</a>, WHDLOAD
проверит, что установленная программа не активизирует
бит BltHog, записывая в <tt>dmacon</tt> регистр. Приоритет
блиттера может создать проблемы на некоторых
аппаратных конфигурациях при использовании всех
его возможностей (при использовании всех каналов).
</p>

<h4>Проверка размера блиттера</h4>

<p>Когда параметр <a href="opt.html#ChkBltSize">ChkBltSize/S</a> активизирован, WHDLOAD
проверит, чтобы блиттер не работал с памятью за
пределами области BaseMem. При доступе на запись в <strong><tt>bltsize</tt>
</strong>или <strong><tt>bltsizh</tt></strong>, он проверяет,
установлен ли линейный режим в <strong><tt>bltcon1</tt></strong>.
Если линейный режим активен, проверка размера
будет отменена. Иначе WHDLoad вычислит первое и
последнее слово к доступу для каждого
активированного канала прямого доступа к памяти.
Если один адрес находится за пределами области
памяти BaseMem, то программа будет завершена с
выводом окна сообщения. Вычисление
предназначено для работы со всеми режимами
(ascending/descending, positive/negativ modulos, odd modulos/pointers). <br>
Помните, что режим &quot;line drawing&quot; не проверяется и
что все регистры блиттера могут быть перезаписаны
коппером, в случае если установлен <strong><tt>copcon</tt></strong>.
</p>

<h4>Проверка ожидания блиттера (Blitter Wait Check)</h4>

<p>Когда параметр <a href="opt.html#ChkBltWait">ChkBltWait/S</a> активирован, WHDLOAD будет
использовать трассировку инструкций на предмет
того, что установленная программа действительно
правильно ждет окончания работы блиттера, перед
его следующим запуском. Whdload использует
внутреннюю переменную, которая отображает
рабочее состояние блиттерa. Переменная устанавливается,
когда производится запись в <tt>bltsize</tt> или <tt>bltsizh</tt>,
и сбрасывается, когда происходит чтение из
регистра <tt>dmaconr</tt>. При каждой записи в регистр
блиттера, проверяется значение переменной, и
если значение показывает, что блиттер запущен, то
установленная программа будет завершена, а WHDLoad
сообщит PC последней запущенной задачи блиттера
совместно с реальным доступом.<br>
У данного параметра есть два главных недостатка:<br>
1) использование блиттера через коппер НЕ проверяется;<br>
2) использование перерываний блиттера вынудит
процедуру проверки выводить бессмысленные
сообщения об ошибках.</p>

<h4>Проверка синхронизации цвета</h4>
Когда активирован параметр <a href="opt.html#ChkColBst">ChkColBst/S</a>,
WHDLoad проверяет, что при каждой записи в регистр <code>custom.bplcon0</code> выставлен бит <code>color</code>.
Некоторое аппаратное обеспечение, особенно flickerfixer требуют для вывода правильного видеосигнала, чтобы этот бит был выставлен.
Для лучшей совместимости следует всегда выставлять этот бит.
Проверяется прямая запись в <code>custom.bplcon0</code> и запись посредством Копперлистов (copperlists). 


<h4>Проверка Copper Control</h4>

Когда активирован параметр <a href="opt.html#ChkCopCon">ChkCopCon/S</a>, WHDLoad
проверяет, что при каждой записи в регистр <code>custom.copcon</code> не установлен бит #1.
Этот бит включает возможность Коппера записывать в регистры Блиттера.
Иногда это может быть полезно для определения используют ли программы Коппер для управления DMA.


<h4>Планы на будущее</h4>

<p>Планируется реализовать такую возможность, как
приостановка программы и свёртывание ее в иконку.
Для этого требуется <strong>Snoop</strong>.
Поэтому, для обеспечения совместимости в дальнейшем, рекомендую авторам инсталляционных модулей
проверять корректность работы ваших патчей с параметром Snoop.</p>

<h4>Системные требования</h4>

<p>Для работы параметра Snoop необходим диспетчер
памяти (MMU). WHDLoad также должен <a href="mmu.html#usercontrol">использовать</a>
MMU, поэтому на машинах с процессорами 68030 необходимо
активизировать опцию <a href="opt.html#MMU">MMU/S</a>. </p>

<h4>Ограничения</h4>

<ul>
  <li>68020 + 68851 <ul>
      <li>Эта конфигурация в данный момент не поддерживается</li>
    </ul>
  </li>
  <li>68030 <ul>
      <li>доступ "чтение-изменение-запись" к регистрам CIA не обнаружен</li>
    </ul>
  </li>
  <li>68040 
  <ul>
<li>доступ "чтение-изменение-запись" к регистрам CIA не обнаружен
<li>команды чтения памяти <tt>movem</tt> могут получить доступ к некорректным Custom регистрам без сообщения об ошибке Access Fault,
это возможно потому, что только первая попытка доступа будет проверена на соответствие корректным регистрам
<li>команды не должны получить доступ к более чем одному отслеживаемому регистру единовременно,
это означает, что код типа <tt>move.b ($dff006),($bfd800)</tt> не сможет быть обработан,
если встретится такой код, WHDLoad отобразит ошибку Access Fault.
</ul>
  </li>
  <li>68060 <ul>
      <li>Инструкция<tt> <strong>movem</strong></tt> может обратиться к
        недействительному регистру, не создав при этом
        сообщения об ошибке доступа. Это возможно потому,
        что только первое обращение будет обработано на
        соответствие действительному регистру.</li>
      <li>Инструкция<tt> move &lt;CIA/Custom register&gt;,sr</tt>&nbsp; будет
        выполнена неправильно, если она изменяет часть
        регистра статуса, принадлежащую супервайзеру,
        часть супервайзера не изменится. </li>
      <li>Любая из команд <tt>(ssp)+</tt> или <tt>-(ssp)</tt> совместно
        с доступом по записи в регистры CIA или Custom не
        может быть обработана в связи с проблемами
        фрейма стека. WHDLoad обнаружит такое обращение и
        завершит работу программы с соответствующим
        сообщением.</li>
      <li>Инструкции не должны одновременно обращаться к
        более чем одному &quot;snooped&quot;-регистру. Это
        означает, что код, подобный move.b ($dff006), ($bfd800) не
        может быть обработан и если такой код выполнится,
        то WHDLOAD выведет сообщение об ошибке доступа.</li>
    </ul>
  </li>
</ul>
</body>
</html>
