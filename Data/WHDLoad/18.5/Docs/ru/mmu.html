<html>

<head>
<title>WHDLoad and the MMU</title>
<meta name="DC.Language" content="ru">
<meta http-equiv="content-language" content="ru">
<meta http-equiv="content-type" content="text/html; charset=windows-1251">
<!-- $Id: mmu.html 1.7 2014/12/04 23:37:38 wepl Exp wepl $ -->
</head>

<body>

<h3>WHDLoad и диспетчер памяти (MMU)</h3>

<p>Диспетчер памяти (MMU) имеется в следующих
процессорах семейства 680xx: 68030, 68040, 68060. 
Есть также, так называемые, EC-версии этих процессоров, в корорых MMU отсутствует. 
Например, во всех стандартных компьютерах модели A4000/030 установлен
только процессор 68EC030. На акселераторах
сторонних призводителей могут устанавливаться
различные процессоры, поэтому для получения
информации о конкретном акселераторе слудует
обратиться к его документации. Насколько известно,
все модели 68040/68060, которые когда-либо
встраивались в Амиги, были полноценными версиями,
содержащими рабочий MMU (потому как burstmode и Zorro III требуют его для функций ввода/вывода). 
Различия между полным центральным процессором и версией EC не могут быть устранены на уровне программного
обеспечения (по крайней мере, с приемлемой скоростью). Поэтому пользователь должен
самостоятельно установить <a href="#usercontrol">соответствующие опции</a> для WHDLoad.<br>
Для 68020 существует внешний диспетчер памяти, называемый 68851, но в настоящее время он не
поддерживается программой WHDload.</p>

<h4>Возможности диспетчера памяти и его использование в WHDLoad</h4>

<p>Главная цель диспетчера памяти состоит в том,
чтобы переводить логические адреса в физические.
Это требуется для работы виртуальной памяти и
для автономного адресного пространства.
Другая возможность состоит в том, чтобы указывать такие свойства, как защиту от записи &quot;только для супервайзера&quot; (&quot;Supervisor Only &quot;),
и режим кэширования для каждого участка физической памяти (WHDLoad использует
размер таблицы равный 4096 байт). 

WHDLoad не использует перевод логических адресов в физические. Но зато
использует MMU для <a href="#mem">защиты памяти</a>, <a
href="cache.html">работы с кэшем</a> и ещё для некоторых
специальных возможностей (<a href="snoop.html">Snooping</a>, <a
href="../autodoc.html">resload_Protect *?</a>).</p>

<h4><a name="mem">Защита памяти в WHDLoad</a></h4>

<p>При запуске, WHDLoad просматривает память, строит
дерево перевода адресов, вклющее всю доступную
память и отмечает следующие адреса как
достоверные и доступные: $0... BaseMem (берёт
информацию из Slave-модуля), $dff000... $dff200
(Custom-регистры), $bfd000... $bff000 (Cia-регистры) и память,
используемую Slave-модулем и с самой программой
WHDLoad. Если в памяти обнаружен отладчик, то память,
используемая отладчиком, будет также помечена,
как доступная. Вся другая память помечается как
недоступная, и поэтому каждое обращение к такой
области (чтение или запись), инициирует сообщение
об ошибке доступа к памяти и WHDLoad завершит свою
работу с выводом соответствующего сообщения. </p>

<h4><a name="usercontrol">Управление диспетчером памяти в WHDLoad со стороны пользователя</a></h4>

<p>Существует 3 режима взаимодействия WHDLoad с
диспетчером памяти.

<ol>
  <li><b>Ignore MMU (игнорирование диспетчера памяти)</b>:<br>
    При этом способе WHDLoad не изменяет регистров
    диспетчера памяти. Это бывает полезным, если
    имеется еще какая-то программа, также работающая
    &nbsp; в данный момент с диспетчером памяти
    (например, такая как системный монитор&nbsp;TK) и вы
    не хотите повлиять на функционирование этой
    программы. Предупреждение: поскольку WHDLoad
    самостоятелно не управляет диспетчером памяти,
    то возможна масса проблем. Эти проблемы могут
    создать крах системы или как-то нарушить
    нормальное функционирование системы. Вот список
    возможных проблем: <ul>
      <li>Если запущены Enforcer/CyberGuard или подобные
        программы, то они заблокируют либо перезагрузят
        систему, потому что WHDLoad создаст большую серию
        обращений всякий раз, при отключении OS. Эти
        обращения не являются ошибками, это нормальное
        поведение программы WHDLoad.</li>
      <li>Более новые версии <strong>68060.library</strong> (начиная с
        версии 41.1) переадресуют память $0-$1000 (первая
        страница) в быструю (Fast) память, используя
        диспетчер памяти. 
		В режиме &quot;<b>ignore MMU</b>&quot;, эта
        переадресация останется нетронутой, если
        установленная программа попытается
        использовать эту память для любых операций с DMA
        (например, copperlist в этой области памяти). Результат
        будет непредсказуем, потому что центральный
        процессор в момент DMA-операций будет
        читать/писать в быструю (Fast) память, а реальная
        Chip-память будет содержать в этот момент
        случайные данные.</li>

      <li>Если запущенный MMU работает с памятью (exception handler,
        translation tree, ...) внутри базовой (BaseMem) памяти
        установленной программы, то это может привести к
        ошибке, потому что BaseMem будет изменена в
        момент выполнения установленной программы.</li>
      <li>В общем, каждая программа, которая изменяет
        основные функции системы (используя диспетчер
        памяти), может конфликтовать с WHDLoad...</li>
    </ul>
  </li>
  <li><b>Disable MMU (отключение диспетчера памяти)</b>:<br>
    Этот способ возможен только на процессорах 68030.
    Диспетчер памяти будет выключен и WHDLoad не сможет
    использовать возможности MMU. </li>
  <li><b>Use MMU (использование диспетчера памяти)</b>:<br>
    При этом способе WHDLoad берет полный контроль над MMU
    и осуществляет защиту памяти и управление кэшем
    центрального процессора, как объяснялось выше.</li>
</ol>

<p>Для процессоров 68030 режимом по умолчанию
является <i>Disable MMU</i>.<br>
Для процессоров 68040/68060 - <i>Use MMU</i>.</p>

<p>Существует два параметра для управления
состоянием диспетчера памяти:<br>
&nbsp;&nbsp;&nbsp; <a href="opt.html#MMU">MMU/S</a> заставляет WHDLoad
использовать режим <i>Use MMU</i> и требуется на
системах с процессором 68030 для включения
возможностей диспетчера памяти.<br>
&nbsp;&nbsp;&nbsp; <a href="opt.html#NoMMU">NoMMU/S</a> отключает
использование MMU программой WHDLoad (<i>Ignore MMU</i>). </p>

<p align="center"><cite>An Enforcer hit is an Enforcer hit, period.</cite> (Michael Sinz)</p>
</body>
</html>
