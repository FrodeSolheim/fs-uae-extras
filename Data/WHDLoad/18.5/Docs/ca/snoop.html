<HTML>
<HEAD>
<TITLE>Snooping</TITLE>
<meta name="DC.Language" content="ca">
<meta http-equiv="content-language" content="ca">
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
<!-- $Id: snoop.html 1.3 2014/12/04 23:37:38 wepl Exp wepl $ -->
</head>
<BODY>
<h3>Snooping</h3>
<h4>De què es tracta?</h4>
Snooping és una funcionalitat de WHDLoad que registra i valida els accessos als registres Custom i CIA. Si 
<a href="opt.html#Snoop">Snoop</a> està activat, tots els accessos invàlids crearan una Falla d'Accés i el programa instal·lat
 acabarà. WHDLoad mostrarà un diàleg indicant el motiu de l'error.
<h4>Registres Custom</h4>Es verifiquen tots els accessos de lectura/escriptura als registres Custom. Els accessos no vàlids son :
<ul>
<li>Accessos a registres inexistents
<li>Accessos de lectura a registres de només escriptura
<li>Accessos d'escriptura a registres de només lectura
<li>Accessos a registres Early Read
<li>Accessos d'escriptura de byte (excepte <tt>bltcon0l</tt> i <tt>aud*vol+1</tt>)
</ul>
Els registres Strobe es poden llegir o escriure. El conjunt de registres Custom vàlids pot variar entre OCS 
(Old ChipSet - A500, A1000, A2000 vells), ECS (Enhanced ChipSet - A600, A2000 nous, A3000) i AGA (Advanced Graphics - A1200,
 A4000). Això és útil especialment per a localitzar errors en programes vells causats per accessos no definits als nous 
registres AGA.

<p>Emprant la funció <a href="../autodoc.html#resload_Control">resload_Control</a> i els tags 
<a href="../autodoc.html#WHDLTAG_CUST">WHDLTAG_CUST_DISABLE/READ/STROBE/WRITE</a> es pot modificar la configuració interna de WHDLoad 
que estableix quins registres són de lectura/escriptura. Amb això, es poden ignorar els accesos il.legals o detectar els que són legals. 
Això només s'hauria d'utilitzar durant el procés de desenvolupament i no en Esclaus alliberats al públic.

<h4>Registres CIA</h4>Als registres CIA només es verifica l'accés d'escriptura. Això vol dir que els accessos
de lectura a registres inexistents a l'àrea de memòria $bfd000...$bfefff no seràn detectats. Per a tots els accessos
d'escriptura, el valor escrit serà guardat internament per WHDLoad. Per a alguns registres CIA s'estableixen comprovacions
especials depenent del valor que s'ha escrit : 

<p><table border=1 summary="Taula de registers CIA">
<tr>
	<th>adreça</th>
	<th>registre</th>
	<th>comprovació</th>
</tr><tr>
	<td>$bfe001</td>
	<td>ciaa.ciapra</td>
	<td>Es prohibeix establir el bit #0 d'Overlay.</td>
</tr><tr>
	<td>$bfe201</td>
	<td>ciaa.ciaddra</td>
	<td>Els bits #6-7 poden tenir qualsevol valor (emprats per al joypad) mentre que els bits inferiors han d'ésser	%000011</td>
</tr><tr>
	<td>$bfe801</td>
	<td>ciaa.ciatodlow</td>
	<td rowspan=3>No es permeten accessos de lectura-escriptura-modificació (p.ex. bchg) si el bit ALARM está establert a ciaa.ciacrb (només es comprova als 68060)</td>	
</tr><tr>
	<td>$bfe901</td>
	<td>ciaa.ciatodmid</td>
</tr><tr>
	<td>$bfea01</td>
	<td>ciaa.ciatodhi</td>
</tr><tr>
	<td>$bfed01</td>
	<td>ciaa.ciaicr</td>
	<td>No es permeten accessos de lectura-modificació-escriptura (p.ex.: bchg) (només es comprova als 68060)</td>	
</tr><tr>
	<td>$bfd100</td>
	<td>ciab.ciaprb</td>
	<td>No s'han d'esborrar els bits de MOTOR #7, SELECT #3-6 i STEP #0, es poden canviar altres bits; així, es 
	detectarà qualsevol accés a les unitats de disc (floppy drives).</td>
</tr><tr>
	<td>$bfd200</td>
	<td>ciab.ciaddra</td>
	<td>El valor escrit ha de ser %11000000</td>
</tr><tr>
	<td>$bfd300</td>
	<td>ciab.ciaddrb</td>
	<td>El valor escrit ha de ser %11000000</td>
</tr><tr>
	<td>$bfd800</td>
	<td>ciab.ciatodlow</td>
	<td rowspan=3>No es permeten accessos de lectura-escriptura-modificació (p.ex. bchg) si el bit ALARM está establert a ciaa.ciacrb (només es comprova als 68060)</td>
</tr><tr>
	<td>$bfd900</td>
	<td>ciab.ciatodmid</td>
</tr><tr>
	<td>$bfda00</td>
	<td>ciab.ciatodhi</td>
</tr><tr>
	<td>$bfdd00</td>
	<td>ciab.ciaicr</td>
	<td rowspan=3>No es permeten accessos de lectura-escriptura-modificació (p.ex. bchg. Només es comprova als 68060)</td>
</tr></table>

<h4>Com funciona?</h4>
Si Snoop està activat, WHDLoad marca les adreces dels registres Custom i CIA com a invàlides/protegides contra escriptura en 
l'arbre de traducció de la MMU. A causa d'això, cada accés a un registre Custom o CIA ocasionarà una excepció de Falla d'Accés. 
El gestor d'excepcions dintre de WHDLoad tractarà aquesta excepció: Primer controlarà si l'accés és vàlid; Si l'accés és invàlid 
el programa finalitzarà. Si l'accés és vàlid i és tracta d'una operació de lectura, serà emulat i l'execució del programa continuarà. 
Si és una operació d'escriptura, WHDLoad addicionalment guardarà els valors escrits en un espai d'emmagatzematge intern. 
<br>

A causa de la sobrecàrrega de l'excepció i la seqüència d'emulació el programa patirà un alentiment a l'execució. 
La quantitat d'aquest alentiment dependrà del tipus de CPU, el tipus de Memòria Xip (16/32 bits) i l'alineament del Punter
 de Pila si la Memòria Xip és de 32 bits (Paraules Llargues alineades o no). També diferirà pel tipus d'accés (Byte/Paraula/
Paraula Llarga, Lectura/Escriptura). En processadors 68030 l'Escriptura serà més ràpida que la Lectura (degut al fet que 
durant les lectures l'entorn de pila és de 92 bytes i en escriptures és de 32 bytes), al 68060 les Lectures seran mes 
ràpides degut al fet que l'emulació per a les Escriptures és més complexa. 

<h4>Mode Snoop Ràpid (Fast Snoop)</h4>
L'opció <a href="opt.html#Snoop">Snoop/S</a> activa el mode de snoop ràpid. Els accessos de lectura no es comprovaran. No 
es realitzaran controls especials. Aquest mode només serà útil per a obtenir el contingut dels registres Custom, per ex. 
per a salvar una pantalla usant <a href="sp.html">SP</a>.

<h4>Analitzador de la CopperList</h4>
Des de la versió 13 de WHDLoad també la copperlist en sí mateixa es comprova. L'analitzador s'activa durant les escriptures
als registres <tt>coplc</tt> si el DMA de copper està activat, o quan el programa instal·lat activa el DMA de copper 
escrivint el registre <tt>dmacon</tt>. L'analitzador seguirà les llistes del Copper i validarà totes les instruccions Move aplicant 
les restriccions causades per l'opció Snoop (OCS/ECS/AGA). Les instruccions Skip i Wait (excepte CEND) s'ignoraran. Quan 
trobi entrades invàlides, el programa instal·lat finalitzarà. L'analitzador segueix les ramificacions (<tt>copjmp</tt>), 
detecta cicles i comprova fins a 16 subllistes. Els Move's a les llistes copper es desen a l'emmagatzematge intern de registres Custom 
que es bolca en sortir de WHDLoad. L'analitzador no es troba actiu al mode Snoop Ràpid. 

<h4>Comprovació de l'apuntador d'àudio</h4>
Quan s'activa l'opció <a href="opt.html#ChkAudPt">ChkAudPt/S</a> WHDLoad comprovarà que el programa instal.lat escrigui només adreces
vàlides als apuntadors Custom d'àudio DMA. Per vàlid s'entén que l'apuntador ha d'estar dintre BaseMem i ésser diferent de 0. Només
es comproven operacions d'escriptura de longs; l'escriptura de paraules (words) no es comprova. Aquesta comprovació pot ésser útil 
per a rutines de reproducció d'àudio.

<h4>Comprobació de la Prioritat del Blitter</h4>
Quan l'opció <a href="opt.html#ChkBltHog">ChkBltHog/S</a> es trobi activa, WHDLoad comprovarà que el programa instal·lat no activi el bit <tt>BltHog</tt> 
 escrivint al registre <tt>dmacon</tt>. La Prioritat del Blitter pot causar problemes en algunes configuracions de 
maquinari en conjunt amb grans operacions del blitter (on s'usin tots els canals). 

<h4>Comprovació del Tamany del Blitter</h4>
Quan s'activa l'opció <a href="opt.html#ChkBltSize">ChkBltSize/S</a> WHDLoad comprovarà que els treballs del blitter no accedeixin memòria fora de l'àrea 
BaseMem. En accessos d'escriptura a <tt>bltsize</tt> o <tt>bltsizh</tt> comprova si el mode lineal està activat a bltcon1. 
Si el mode lineal està activat, cancel·larà el control de tamany. En cas contrari WHDLoad calcularà la primera i última 
paraula on accedir per a cada canal actiu de DMA. Si una adreça es troba fora de l'àrea BaseMem el programa finalitzarà amb
un quadre de diàleg. El càlcul està dissenyat per a treballar en tots els modes (ascendent/descendent, mòduls positius/
negatius, mòduls/punters imparells). 
<br>
Tingui en compte que el mode de dibuix de línies no serà verificat i que tots els registres del blitter poden ser escrits pel 
copper si <tt>copcon</tt> està configurat.

<h4>Comprovació de l'Espera del Blitter</h4>
Quan l'opció <a href="opt.html#ChkBltWait">ChkBltWait/S</a> està activa, WHDLoad empra un seguiment d'instruccions per a verificar que el programa instal·lat
 espera correctament que el blitter acabi abans de començar un altre treball de blitter. S'utilitza una variable interna 
que representa l'estat de treball del blitter. La variable és configurada quan es produeix un accés d'escriptura a 
<tt>bltsize</tt> o <tt>bltsizh</tt> i desactivada quan es realitza un accés de lectura al registre <tt>dmaconr</tt>. 
A cada escriptura a un registre del blitter es comprova el valor de la variable interna, si es troba un treball de 
blitter en execució, el programa instal·lat finalitzarà i WHDLoad informarà l'ordinador de l'últim treball de blitter 
arrencat conjuntament amb l'accés actual. 
<br>
Hi ha dos colls d'ampolla principals en aquesta funcionalitat. Primer, l'ús de blitter a través del copper no es comprova,
 i segon, l'ús de les interrupcions del blitter ocasionen que la rutina de comprovació reporti errors inexistents.
 
<h4>Comprovació de ràfega de color</h4>
Quan s'activa l'opció <a href="opt.html#ChkColBst">ChkColBst/S</a> WHDLoad comprova que el bit de <code>color</code> estigui activat a cada escriptura al 
registre <code>custom.bplcon0</code>. Algun maquinari, especialment flickerfixers, requereixen l'activació d'aquest bit per a treure un senyal de vídeo 
adequat. Per a millor compatibilitat sempre s'hauria d'activar aquest bit. Es comproven les escriptures directes a <code>custom.bplcon0</code> i les 
escriptures via llistes de copper.
 
<h4>Comprovació de Control del Copper</h4>

Quan s'activa l'opció <a href="opt.html#ChkCopCon">ChkCopCon/S</a>, WHDLoad comprova a cada escriptura al registre <code>custom.copcon</code> que el bit #1 no 
s'hagi establert. Aquest bit activa la capacitat del Copper d'escriure als registres del Blitter. Pot resultar útil a vegades per detectar si hi ha 
programes que empren el Copper per a controlar activitats DMA.
 
<h4>El futur</h4>
S'ha planejat implementar funcionalitats tals com Congelat i Iconificat. Per a les mateixes, Snoop és un requeriment. 
Per tant és recomanable que els autors dels instal·ladors comprovin els seus instal·ladors amb Snoop per a 
assegurar la compatibilitat futura. 
<h4>Requeriments</h4>
Es requereix una MMU per a la funcionalitat Snoop. WHDLoad també <a href="mmu.html#usercontrol">ha</a> d'utilitzar la MMU i en 
conseqüència s'ha d'activar l'opció <a href="opt.html#MMU">MMU/S</a> en màquines basades en 68030.
<h4>Limitacions</h4>
<ul>
<li>68020 + 68851
<ul>
<li>Aquest maquinari no és suportat actualment
</ul>
<li>68030
<ul>
<li>No es detecten accessos de lectura-modificació-escriptura als registres CIA
</ul>
<li>68040
<ul>
<li>No es detecten accessos de lectura-modificació-escriptura als registres CIA
<li>Les instruccions <tt>movem</tt> de lectura de memòria poden accedir registres Custom no vàlids sense generar una excepció de fallada d'accés (Acces Fault), això
és possible perquè només es verifica que el primer accés sigui a un registre vàlid.
<li>Les instruccions no han d'accedir més d'un registre furtiu (snooped) d'un cop. Això vol dir que no es pot gestionar codi com <tt>move.b ($dff006),($bfd800)</tt>, si
això passa WHDLoad mostrarà un missatge de fallada d'accés (Acces Fault).
</ul>
<li>68060
<ul>
<li>Les instruccions <tt>movem</tt> poden accedir a un registre invàlid sense ocasionar una excepció de Falla d'Accés, això 
és possible degut al fet que només es verifica que el primer accés concordi amb un registre vàlid.

<li><tt>move &lt;registre CIA/Custom&gt;,sr</tt> serà executat incorrectament si intenta canviar la part supervisor del 
registre d'estat, la part de supervisor romandrà sense canvis 

<li>Qualsevol instrucció <tt>(ssp)+</tt> o <tt>-(ssp)</tt> en conjunt amb un accés d'escriptura a un registre CIA o Custom 
no pot ser gestionat degut a problemes de marc de pila, en aquest cas, WHDLoad detectarà tals accessos i acabarà amb el 
quadre de diàleg apropiat 

<li>Les instruccions no han d'accedir més d'un registre controlat per Snoop al mateix temps; això significa que codi com 
 <tt>move.b ($dff006),($bfd800)</tt> no pot ésser gestionat. Si té lloc una situació com aquesta, WHDLoad mostrarà un 
diàleg de Falla d'Accés
</ul>
</ul>
</BODY>
</HTML>
