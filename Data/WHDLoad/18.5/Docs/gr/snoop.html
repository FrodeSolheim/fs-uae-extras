<HTML>
<HEAD>
<TITLE>Snooping - Παρατήρηση</TITLE>
<meta name="DC.Language" content="gr">
<meta http-equiv="content-language" content="gr">
<meta http-equiv="content-type" content="text/html; charset=iso-8859-7">
<!-- $Id: snoop.html 1.3 2015/04/19 21:08:08 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Snooping - Παρατήρηση</h3>
<h4>Τι είναι</h4> Η παρατήρηση (Snooping) είναι ένα χαρακτηριστικό του WHDLoad που πραγματοποιεί ελέγχους και καταγραφές προσβάσεων στους καταχωρητές Custom και CΙΑ. Αν η <a 
href="opt.html#Snoop">Snoop</a> έχει ενεργοποιηθεί όλες οι άκυρες προσβάσεις θα δημιουργήσουν 
ένα Access Fault και το εγκατεστημένο πρόγραμμα θα τερματιστεί. Το WHDLoad θα εμφανίσει ένα
μήνυμα με τον λόγο του σφάλματος.

<h4>Custom καταχωρητές</h4>Κάθε πρόσβαση ανάγνωσης και εγγραφής στους custom καταχωρητές
επιβεβαιώνεται. Τέτοιες προσβάσεις είναι:
<ul>
<li>προσβάσεις σε ανύπαρκτους καταχωρητές
<li>προσβάσεις ανάγνωσης σε καταχωρητές Μόνο Εγγραφής
<li>προσβάσεις εγγραφής σε καταχωρητές Μόνο Ανάγνωσης
<li>προσβάσεις σε καταχωρητές Early Read
<li>προσβάσεις εγγραφής byte (εκτός από <tt>BLTCON0L</tt> και <tt>AUD*VOL+1</tt>)
</ul>
Οι καταχωρητές Strobe μπορούν να διαβαστούν ή να γραφούν. Το σετ των έγκυρων καταχωρητών Custom
μπορεί να διαφέρει μεταξύ του OCS (Old ChipSet - A500, A1000, παλιά A2000), ECS (Enhanced ChipSet
- A600, νέα A2000, A3000) και AGA (Advanced Graphics - A1200, A4000). Αυτό είναι
χρήσιμο ειδικά για τον εντοπισμό σφαλμάτων σε παλιά προγράμματα που προκαλούνται από απροσδιόριστες
προσβάσεις σε νέους καταχωρητές AGA.

<p>Χρησιμοποιώντας την λειτουργία <a
href="../autodoc.html#resload_Control">resload_Control</a> και τις ετικέτες <a
href="../autodoc.html#WHDLTAG_CUST">WHDLTAG_CUST_DISABLE/READ/STROBE/WRITE</a>
η εσωτερική διαμόρφωση του WHDLoad όπου οι καταχωρητές είναι αναγνώσιμοι/εγγράψιμοι μπορούν
να τροποποιηθούν. Με αυτό οι μη αποδεκτές προσβάσεις μπορούν να παραβλεθούν ή οι μη αποδεκτές
προσβάσεις να εντοπιστούν. Αυτό θα πρέπει να χρησιμοποιηθεί μόνο κατά την διαδικασία ανάπτυξης
και όχι στην δημόσια κυκλοφορία των Slaves.

<h4>CΙΑ καταχωρητές</h4>Στους καταχωρητές CΙΑ επιβεβαιώνονται μόνο οι προσβάσεις εγγραφής.
Αυτό σημαίνει ότι οι προσβάσεις ανάγνωσης σε μη υπάρχοντες καταχωρητές στη περιοχή μνήμης
$bfd000...$bfefff δεν θα εντοπιστούν. Για όλες τις προσβάσεις εγγραφής η τιμή που εγγράφεται
θα αποθηκευτεί εσωτερικά από το WHDLoad. Για κάποιους καταχωρητές CΙΑ υπάρχουν ειδικοί ελέγχοι
ανάλογα την τιμή που γράφεται:

<p><table border=1 summary="πίνακας καταχωρητών CIA">
<tr>
	<th>διεύθυνση</th>
	<th>καταχωρητής</th>
	<th>έλεγχος</th>
</tr><tr>
	<td>$bfe001</td>
	<td>ciaa.ciapra</td>
	<td>ο ορισμός του Overlay bit #0 απαγορεύεται</td>
</tr><tr>
	<td>$bfe201</td>
	<td>ciaa.ciaddra</td>
	<td>τα bits #6-7 μπορούν να έχουν οποιαδήποτε τιμή (χρησιμοποιείται για joypad), τα χαμηλότερα bits πρέπει να είναι
	%000011</td>
</tr><tr>
	<td>$bfe801</td>
	<td>ciaa.ciatodlow</td>
	<td rowspan=3>οι προσβάσεις ανάγνωσης-αλλαγής-εγγραφής (e.g. bchg) δεν επιτρέπονται
	εάν το ALARM bit έχει οριστεί στο ciaa.ciacrb (ελέγχεται μόνο σε 68060)</td>
</tr><tr>
	<td>$bfe901</td>
	<td>ciaa.ciatodmid</td>
</tr><tr>
	<td>$bfea01</td>
	<td>ciaa.ciatodhi</td>
</tr><tr>
	<td>$bfed01</td>
	<td>ciaa.ciaicr</td>
	<td>οι προσβάσεις ανάγνωσης-αλλαγής-εγγραφής (e.g. bchg) δεν επιτρέπονται (ελέγχεται
	μόνο σε 68060)</td>
</tr><tr>
	<td>$bfd100</td>
	<td>ciab.ciaprb</td>
	<td>τα bits για MOTOR #7, SELECT #3-6 και STEP #0 δεν πρέπει να 
	καθαριστούν, άλλα bits μπορούν να αλλάξουν. Με αυτά οποιαδήποτε πρόσβαση στα
	floppy drives θα εντοπιστεί</td>
</tr><tr>
	<td>$bfd200</td>
	<td>ciab.ciaddra</td>
	<td>η τιμή που γράφεται πρέπει να είναι %11000000</td>
</tr><tr>
	<td>$bfd300</td>
	<td>ciab.ciaddrb</td>
	<td>η τιμή που γράφεται πρέπει να είναι %11111111</td>
</tr><tr>
<td>$bfd800</td>
	<td>ciab.ciatodlow</td>
	<td rowspan=3>οι προσβάσεις ανάγνωσης-αλλαγής-εγγραφής (e.g. bchg) δεν επιτρέπονται
	εάν το ALARM bit έχει οριστεί στο ciab.ciacrb (ελέγχεται μόνο σε 68060)</td>
</tr><tr>
	<td>$bfd900</td>
	<td>ciab.ciatodmid</td>
</tr><tr>
	<td>$bfda00</td>
	<td>ciab.ciatodhi</td>
</tr><tr>
	<td>$bfdd00</td>
	<td>ciab.ciaicr</td>
	<td>οι προσβάσεις ανάγνωσης-αλλαγής-εγγραφής (e.g. bchg) δεν επιτρέπονται (ελέγχεται
	μόνο σε 68060)</td>
</tr></table>

<h4>Πως λειτουργεί</h4>
Αν ενεργοποιηθεί η Snoop, το WHDLoad σημειώνει τις διευθύνσεις των καταχωρητών Custom και CIA ως
άκυρες στο δέντρο μετάφρασης της MMU. Λόγω αυτού, κάθε πρόσβαση σε καταχωρητή Custom ή CIA
θα έχει σαν αποτέλεσμα μια εξαίρεση Access Fault. Ο χειριστής εξαιρέσεων στο
WHDLoad χειρίζεται αυτή την εξαίρεση. Πρώτα ελέγχει αν η πρόσβαση είναι έγκυρη. Αν η
πρόσβαση είναι άκυρη το πρόγραμμα θα τερματιστεί. Αν η πρόσβαση είναι έγκυρη και
πρόκειται για λειτουργία ανάγνωσης θα εξομοιωθεί και η εκτέλεση του προγράμματος
συνεχίζεται. Αν πρόκειται για λειτουργία εγγραφής το WHDload επιπλέον θα αποθηκεύσει την τιμή
σε μια εσωτερική καταχώρηση.
<br>Λόγω της επιβάρυνσης στη διαδικασία εξαίρεσης και εξομοίωσης
η ταχύτητα εκτέλεσης του προγράμματος θα καθυστερήσει. Πόσο θα καθυστερήσει εξαρτάται από την CPU,
τον τύπο μνήμης Chip (16/32-bit) και την στοίχιση του δείκτη στοίβας (Stackpointer) αν η μνήμη Chip
είναι 32-bit (LongWord στοίχιση ή όχι). Διαφέρει επίσης ανάλογα τον τύπο πρόσβασης
(Byte/Word/LongWord, Read/Write). Στον 68030 οι Εγγραφές είναι γρηγορότερες από
τις Αναγνώσεις (γιατί στις αναγνώσεις το πλαίσιο στοίβας (stackframe) είναι 92 bytes, στις εγγραφές 32 bytes), στον
68060 οι Αναγνώσεις είναι γρηγορότερες γιατί η εξομοίωση για τις Εγγραφές είναι
πιο πολύπλοκη.

<h4>Λειτουργία Γρήγορης Παρατήρησης</h4>
Η επιλογή <a href="opt.html#Snoop">Snoop/S</a> ενεργοποιεί την γρήγορη παρατήρηση. Οι προσβάσεις Ανάγνωσης
δεν θα ελεγχθούν. Δεν πραγματοποιούνται ειδικοί έλεγχοι. Αυτή η λειτουργία ίσως είναι χρήσιμη για
να πάρετε μόνο δεδομένα από τους καταχωρητές Custom, π.χ. για αποθήκευση μιας εικόνας χρησιμοποιώντας το <a
href="sp.html">SP</a>.

<h4>Σαρωτής Copper List</h4>
Από την έκδοση 13 του WHDLoad θα ελεχθούν επίσης και οι copperlists. Ο
σαρωτής θα ενεργοποιηθεί σε εγγραφές στους καταχωρητές <tt>COPLC</tt> αν το copper
DMA είναι ενεργό, ή όταν το εγκατεστημένο πρόγραμμα ενεργοποιεί το copper DMA
γράφοντας τον καταχωρητή <tt>DMACON</tt>. Ο σαρωτής ακολουθεί τις copperlists και
επιβεβαιώνει όλες τις εντολές Move εφαρμόζοντας τους περιορισμούς που ορίστηκαν
από την επιλογή Snoop (OCS/ECS/AGA). Οι εντολές Skip και Wait (εκτός CEND) θα αγνοηθούν. Όταν
βρει άκυρες καταχωρήσεις το εγκατεστημένο πρόγραμμα θα τερματιστεί. Ο σαρωτής
ακολουθεί τα branches (<tt>COPJMP</tt>), ανιχνεύει loops και ελέγχει μέχρι 16 υπο-λίστες. Οι
εντολές Move στις copperlists θα αποθηκευτούν στο εσωτερικό αρχείο καταχωρητή Custom
που γίνεται αρχείο ένδειξης στην έξοδο του WHDLoad. Ο σαρωτής δεν είναι ενεργός στην Λειτουργία
Γρήγορης Παρατήρησης.

<h4>Έλεγχος Audio Pointer</h4>
Όταν η επιλογή <a href="opt.html#ChkAudPt">ChkAudPt/S</a> είναι ενεργοποιημένη, το WHDLoad
θα ελέγξει ότι το εγκατεστημένο πρόγραμμα γράφει μόνο έγκυρες διευθύνσεις στους δείκτες της
Custom Audio DMA. Έγκυρες σημαίνει ότι ο δείκτης πρέπει να βρίσκεται ανάμεσα στην BaseMem και
να μην ισούνται με 0. Ελέγχονται μόνο οι λειτουργίες εγγραφής long. Οι εγγραφές word δεν
ελέγχονται. Αυτός ο έλεγχος μπορεί να είναι χρήσιμος για εντοπισμό προβλημάτων στις ρουτίνες
αναπαραγωγής ήχου.

<h4>Έλεγχος Blitter Priority</h4>
Όταν ενεργοποιηθεί η επιλογή <a href="opt.html#ChkBltHog">ChkBltHog/S</a> το WHDLoad θα ελέγξει να μην ενεργοποιήσει
το εγκατεστημένο πρόγραμμα, το <tt>BltHog</tt> bit γράφοντας στον καταχωρητή  <tt>DMACON</tt>.
Η προτεραιότητα Blitter μπορεί να προκαλέσει προβλήματα σε μερικούς συνδυασμούς hardware σε
συνδυασμό με μεγάλες λειτουργίες blitter (να χρησιμοποιούνται όλα τα κανάλια).

<h4>Έλεγχος Blitter Size</h4>
Όταν η επιλογή <a href="opt.html#ChkBltSize">ChkBltSize/S</a> ενεργοποιηθεί το WHDLoad θα ελέγξει να μην προσπελάσουν
μνήμη έξω από τη περιοχή BaseMem οι εργασίες του Blitter. Σε προσβάσεις εγγραφής στα
<tt>BLTSIZE</tt> ή <tt>BLTSIZH</tt> ελέγχει αν είναι ενεργοποιημένη η λειτουργία γραμμής (line mode)
στο <tt>BLTCON1</tt>. Αν η line mode είναι ενεργή θα ακυρώσει τον έλεγχο μεγέθους.
Διαφορετικά το WHDLoad θα υπολογίσει την πρώτη και την τελευταία word που έχει πρόσβαση
για κάθε ενεργοποιημένο κανάλι DMA. Αν μια διεύθυνση είναι έξω από τη περιοχή BaseMem το
πρόγραμμα θα τερματιστεί με ένα παράθυρο επιλογής. Ο υπολογισμός είναι σχεδιασμένος
να λειτουργήσει με όλα τις λειτουργίες (αύξουσα/φθίνουσα, θετικά/αρνητικά modulos, περιττούς
modulos/pointers).
<br>Προσέξτε ότι η λειτουργία σχεδιασμού γραμμής (line drawing) δεν θα επιβεβαιωθεί και όλοι οι καταχωρητές του blitter μπορούν επίσης να γραφούν από τον copper εάν οριστεί η <tt>COPCON</tt>.

<h4>Έλεγχος Blitter Wait</h4>
Όταν ενεργοποιηθεί η επιλογή <a href="opt.html#ChkBltWait">ChkBltWait/S</a> το WHDLoad θα χρησιμοποιήσει μια ανίχνευση εντολών
για επιβεβαίωση ότι το εγκατεστημένο πρόγραμμα περιμένει κανονικά τον blitter να
τελειώσει πριν ξεκινήσει μια νέα εργασία του blitter. Χρησιμοποιεί μια εσωτερκή μεταβλητή
που αντιπροσωπεύει την τρέχουσα κατάσταση του blitter. Η μεταβλητή ορίζεται όταν μια
πρόσβαση εγγραφής συμβαίνει στο <tt>BLTSIZE</tt> ή <tt>BLTSIZH</tt> και καθαρίζει όταν
πραγματοποιείται πρόσβαση ανάγνωσης στον καταχωρητή <tt>DMACONR</tt>. Σε κάθε
εγγραφή σε καταχωρητή του blitter η τιμή της εσωτερικής μεταβλητής ελέγχεται,
αν δείχνει μια τρέχουσα εργασία του blitter το εγκατεστημένο πρόγραμμα τερματίζεται
και το WHDLoad θα αναφέρει το PC της τελευταίας εργασίας του blitter που ξεκίνησε
μαζί με την τρέχουσα πρόσβαση.
<br>Υπάρχουν δύο σοβαρές επιβαρύνσεις με αυτό το χαρακτηριστικό. Πρώτον η χρήση του blitter
μέσω του copper δεν ελέγχονται και δεύτερον η χρήση των blitter interrupts
θα προκαλέσει τη ρουτίνα ελέγχου να αναφέρει σφάλματα που δεν θα έπρεπε.

<h4>Έλεγχος Color Burst</h4>
Όταν η επιλογή <a href="opt.html#ChkColBst">ChkColBst/S</a> είναι ενεργοποιημένη, το WHDLoad
ελέγχει ότι σε κάθε εγγραφή στον <code>custom.bplcon0</code> καταχωρητή, το
<code>color</code> bit ορίζεται. Ορισμένα hardware, ειδικά τα flickerfixer απαιτούν
αυτό το bit να ορίζεται για να δώσουν ένα κατάλληλο σήμα βίντεο. Για καλύτερη συμβατότητα
αυτό το bit θα πρέπει να είναι πάντα ορισμένο. Ελεχγένα είναι οι άμεσες εγγραφές στο
<code>custom.bplcon0</code> και γράφονται μέσω των copperlists.

<h4>Έλεγχος Copper Control</h4>
Όταν η επιλογή <a href="opt.html#ChkCopCon">ChkCopCon/S</a> είναι ενεργοποιημένη, το WHDLoad
ελέγχει ότι σε κάθε εγγραφή στον <code>custom.copcon</code> καταχωρητή, το bit #1
δεν έχει οριστεί. Αυτό το bit ενεργοποιεί την δυνατότητα του Copper να γράψει στους
καταχωρητές του Blitter. Μπορεί μερικές φορές να είναι χρήσιμο να εντοπίσεις αν τα προγράμματα
χρησιμοποιούν τον Copper για να ελέγχουν τις δραστηριότητες της DMA.

<h4>Μέλλον</h4>
Σχεδιάζεται να υλοποιηθούν χαρακτηριστικά όπως Πάγωμα (Freezer) και Ελαχιστοποίηση (Iconifing).
Για αυτά, η Snoop είναι απαραίτητη. Οπότε συνιστάται
οι συγγραφείς εγκαταστάσεων να ελέγχουν τις εγκαταστάσεις τους με την Snoop για να
σιγουρέψουν μελλοντική συμβατότητα.
<h4>Απαιτήσεις</h4>
Μια MMU απαιτείται για το χαρακτηριστικό Snoop. Επίσης το WHDLoad πρέπει <a
href="mmu.html#usercontrol">να χρησιμοποιεί</a> MMU, οπότε η <a
href="opt.html#MMU">MMU/S</a> πρέπει να έχει ενεργοποιηθεί σε μηχανήματα με 68030.
<h4>Περιορισμοί</h4>
<ul>
<li>68020 + 68851
<ul>
<li>αυτό το hardware δεν υποστηρίζεται προς το παρόν
</ul>
<li>68030
<ul>
<li>προσβάσεις ανάγνωσης-τροποποίησης-εγγραφής στους καταχωρητές CIA δεν εντοπίζονται
</ul>
<li>68040
<ul>
<li>προσβάσεις ανάγνωσης-τροποποίησης-εγγραφής στους καταχωρητές CIA δεν εντοπίζονται
<li>οι οδηγίες ανάγνωσης μνήμης <tt>movem</tt> μπορούν να έχουν πρόσβαση σε μη έγκυρους
καταχωρητές Custom χωρίς να δημιουργήσουν μια εξαίρεση Access Fault, αυτό είναι δυνατό
διότι μόνο η πρώτη πρόσβαση θα επαληθευτεί για ταίριασμα ενός έγκυρου καταχωρητή
<li>οι οδηγίες δεν πρέπει να έχουν πρόσβαση σε περισσότερο από έναν καταχωρητή παρατήρησης
τη φορά, που σημαίνει ότι κώδικας όπως η <tt>move.b ($dff006),($bfd800)</tt> δεν μπορει
να χειριστεί. Αν συμβεί τέτοιος κώδικας το WHDLoad θα εμφανίσει ένα παράθυρο μηνύματος
Access Fault
</ul>
<li>68060
<ul>
<li>η εντολή <tt>movem</tt> μπορεί να προσπελάσει έναν μη έγκυρο καταχωρητή χωρίς
να δημιουργήσει μια εξαίρεση Access Fault, αυτό είναι δυνατόν γιατί μόνο η πρώτη
προσπέλαση θα επιβεβαιωθεί ότι ταιριάζει με έγκυρο καταχωρητή
<li>η <tt>move &lt;CΙΑ/Custom register&gt;,sr</tt> θα εκτελεστεί λανθασμένα
αν αλλάζει το κομμάτι supervisor του καταχωρητή status, το κομμάτι
supervisor θα παραμείνει απαράλλακτο
<li>κάθε <tt>(ssp)+</tt> ή <tt>-(ssp)</tt> σε συνδυασμό με πρόσβαση
εγγραφής σε ένα καταχωρητή CΙΑ ή Custom δεν μπορεί να ελεχθεί λόγω προβλημάτων του πλαισίου στοίβας (stackframe),
το WHDLoad θα εντοπίσει τέτοιες προσβάσεις και θα τερματιστεί με ένα
κατάλληλο παράθυρο επιλογής
<li>οι εντολές δεν πρέπει να έχουν προσπέλαση σε πάνω από έναν καταχωρητή παρατήρησης κάθε φορά,
αυτό σημαίνει ότι κώδικας όπως <tt>move.b ($dff006),($bfd800)</tt> δεν μπορεί να ελεγχθεί,
αν προκύψει τέτοιος κώδικας το WHDLoad θα εμφανίσει ένα παράθυρο επιλογής Access Fault
</ul>
</ul>
</BODY>
</HTML>
