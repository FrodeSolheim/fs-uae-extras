<html>

<head>
<title>Огляд кеша центрального процесора</title>
<meta name="DC.Language" content="ua">
<meta http-equiv="content-language" content="ua">
<meta http-equiv="content-type" content="text/html; charset=windows-1251">
<!-- $Id: cache.html 1.5 2009/02/05 20:38:15 wepl Exp wepl $ -->
</head>

<body>

<h3>Огляд кеша центрального процесора</h3>

<p>Для збільшення швидкості деякі процесори (CPU) сімейства 68k мають можливість
  при доступі до пам'яті використовувати кеш. Кеші завжди використовують логічну
  адресацію, включаючи функціональний код доступу. Це означає, що доступ у режимі
  користувача (User Mode) і режимі супервайзора (Supervisor Mode) будуть створювати
  різні вхідні дані кеша (за додатковою інформацією звертайтеся до документації
  по процесорах фірми Motorola).</p>

<p>Наводимо короткий огляд особливостей кешей процесорів класа <strong>68k</strong>:
<ul>
  <li>68000 - відсутній </li>
  <li>68010 <ul>
      <li>Команда попередньої вибірки, два слова попередньої вибірки, одне слово
        декодуючого регістра</li>
      <li>Режим Циклу використовується коли за одним словом інструкції слідує
        DBcc, і до закінчення циклу більше немає ніяких інструкцій</li>
    </ul>
  </li>
  <li>68020 <ul>
      <li>Команда попередньої вибірки <br>
        довге слово </li>
      <li>Кеш команд <br>
        16 ліній по 16 байт = 256 байт <br>
        може бути активізован або зупинен через CARC </li>
    </ul>
  </li>
  <li>68030 <ul>
      <li>Команда попередньої вибірки <br>
        довге слово </li>
      <li>Кеш команд <br>
        16 ліній по 16 байт = 256 байт <br>
        може бути активізований або зупинений через CARC
      </li>
      <li>Кеш даних <br>
        16 ліній по 16 байт = 256 байт <br>
        може бути активізований або зупинений через CARC
        <br>
        завжди з наскрізним записом (WriteThrough)<br>
        вибір режиму кешування даних при записі (Write Allocation)</li>
    </ul>
  </li>
  <li>68040 <ul>
      <li>Команда попередньої вибірки <br>
        довге слово </li>
      <li>Кеш команд <br>
        256 ліній по 16 байт = 4096 байт <br>
        може бути активізований через CARC </li>
      <li>Кеш даних <br>
        256 ліній по 16 байт = 4096 байт <br>
        може бути активізований через CARC <br>
        можливість вибору режиму CopyBack/WriteThrough через MMU </li>
    </ul>
  </li>
  <li>68060 <ul>
      <li>Команда попередньої вибірки <br>
        довге слово </li>
      <li>Кеш команд <br>
        512 ліній по 16 байт = 8192 байт <br>
        може бути активізований, зупинений і зменшений
        в 2 рази через CARC </li>
      <li>Кеш розгалуження (Branch Cache)<br>
        може бути активізований через CARC <br>
        не змінюється установками MMU! </li>
      <li>Суперскалярна обробка (Superscalar Dispatch)<br>
        може бути активізований через CARC </li>
      <li>Кеш даних <br>
        512 ліній по 16 байт = 8192 байт <br>
        може бути активізований, зупинений і зменшений
        в 2 рази через CARC<br>
        можливість вибору режиму CopyBack/WriteThrough через MMU </li>
      <li>Push Buffer <br>
        може бути відключений через PCR </li>
      <li>Store Buffer <br>
        може бути активізований через CARC <br>
        Сторінки <strong>не</strong> повинні бути такими що не кешуються (NonCachable
        Serialized (precise)) </li>
    </ul>
  </li>
</ul>

<h4><a name="cache">Робота з кешем в WHDLoad</a></h4>

<p>Перша важлива річ полягає в розумінні того, що кеш процесорів 68030..68060
  управляється за допомогою Регістра Контролю Кеша (<strong>CACR</strong>) і MMU
  (при умові, що WHDLoad використовує MMU й управляє ним)! <br>
  За допомогою CACR кеш може бути включений або виключений. Використовуючи одну
  сторінку пам'яті MMU (4 кб із WHDLoad) можна позначити яким чином буде виконуватись
  кешування. <br>
  На процесорах 68030 сторінка пам'яті може бути такою, що кешується (Cacheable)
  або не кешується (NotCacheable). На процесорах 68040/68060&nbsp; - кешується
  WriteThrough (наскрізно), CopyBack, не кешується NonCachable (неточно)&nbsp;
  або не кешується NonCachable Serialized (точно). </p>

<p>Якщо WHDLoad не використовує MMU, то керування можливо тільки за допомогою
  CACR. </p>

<h4>Стандартні установки кеша</h4>

<p>За замовчуванням області WHDLoad, Slave й ExpMem позначені як такі що кешуються
  CopyBack. Область BaseMem позначена як NonCachable, а кеш даних&nbsp; і кеш
  команд включені через CACR. Таким чином, якщо програма розташовується в області
  BaseMem, то вона запускається з відключеним кешем, але WHDLoad й Slave використовують
  кеш для швидкодії. </p>

<h4>Керування кешем (для програмістів)</h4>

<p>Є дві функції в WHDLoad для керування кешами: <a href="../autodoc.html#resload_SetCACR">resload_SetCACR</a>
  й <a
href="../autodoc.html#resload_SetCPU">resload_SetCPU</a>. <strong>Resload_SetCACR</strong>
  досить стара функція й вона може бути повністю замінена за допомогою r<strong>esload_SetCPU</strong>
  (WHDLoad сам обробляє аргументи функції <strong><a href="../autodoc.html#resload_SetCACR">resload_SetCACR</a></strong> і автоматично
  викликає функцію <strong><a href="../autodoc.html#resload_SetCPU">resload_SetCPU</a></strong>). У будь якому випадку рекомендується
  використовувати функцію <strong><a href="../autodoc.html#resload_SetCACR">resload_SetCACR</a></strong> усім, хто погано знає
  те, як працювати з кешами і який вони мають вплив на систему Аміги. Використання
  функції <strong><a href="../autodoc.html#resload_SetCACR">resload_SetCACR</a></strong> і кеш даних,&nbsp; можна включати й
  відключати незалежно одне від одного. <strong>Resload_SetCACR</strong> впливає
  тільки на кешування області основної пам'яті (BaseMem).</p>

<h4>Керування кешем (для користувачів)</h4>

<p>Якщо програміст відповідально підійшов до своєї роботі, то користувачеві взагалі
  не потрібно ламати голову щодо установок кеша, оскільки всі настроювання кеша
  будуть виконані Slave-модулем самостійно. <br>
  Однак, може бути дві причини для зміни установок кеша вручну. Перша - це проблеми
  з установленою програмою, через те що вона працює занадто швидко (наприклад,
  відбувається псування графіки), а друга , щоб прискорити роботу установленої
  програми. </p>

<p>Щоб змусити працювати програми, які приводять до помилки&nbsp; через використання
  кеша, потрібно активізувати опцію <a href="opt.html#NoCache">NoCache</a>. Ця
  опція виключає всі кеші й позначає всю пам'ять як таку що не кешується NonCachable
  Serialized (точно). Якщо комп'ютер має 32-бітну Chip-пам'ять то він, буде працювати
  швидше ніж A500. </p>

<p>Для того щоб прискорити роботу встановленої програми, можуть бути виставлені
  деякі опції для активації кеша. Ці опції будуть перезаписувати внутрішні установки
  Slave-модуля. Із процесорами 68020 може бути встановлена опція <a
href="opt.html#Cache">Cache</a> . Із процесорами 68030 ще може бути використана
  й опція <a href="opt.html#DCache">DCache</a>, яка також містить у собі опцію
  керування кешем. Для використання із процесорами 68060 існує ще кілька опцій
  керування кешами: <a href="opt.html#BranchCache">BranchCache</a>, <a
href="opt.html#StoreBuffer">StoreBuffer</a> й <a href="opt.html#SuperScalar">SuperScalar</a>.
  Опція <a href="opt.html#ChipNoCache">ChipNoCache/S</a> може збільшити продуктивність
  на процесорах 68040 й 68060 (див. нижче). <a name="chipmem"></a></p>

<h4>Кешування чип-пам'яті (Chip-Memory)</h4>

<p>Кешування може виконуватися не тільки засобами самого процесора (CACR) і MMU,
  а й зовнішніми апаратними засобами. Процесор по шині передає сигнал у випадку,
  якщо він намагається кешувати доступ. І зовнішні апаратні засоби можуть сигналізувати
  процесору (після того як адреса була виставлена на шині адреси під час доступу
  до пам'яті), що доступ не повинен кешуватися. <br>
  На скільки мені відомо, на всіх Амигах і зовнішніх акселераторах, що містять
  процесор не нижче 68030 (тому що вони мають кеш даних), апаратні засоби повідомляють
  процесору, що пам'ять не кешуєтся або не використовується. Вплив відбувається
  на всю Chip-пам'ять й область IO (Cia/Custom/RTC) які не повинні кешуватися
  кешем даних. Це необхідно для того, щоб уникнути конфліктів, наприклад, через
  роботу DMA. <br>
  Реакція процесора на апаратну відмову кешування доступу може відрізнятися на
  різних типах процесорів. На 68030 немає ніякого впливу на швидкість доступу,
  дані просто не будуть кешуватися. На 68040 доступ на читання буде виконуватися
  з максимальною швидкістю, але доступ на запис (CopyBack) буде відмінний і початий
  спочатку без кешування, що призводить до того, що доступ буде приблизно в 5
  разів (залежить від апаратних засобів і швидкості процесора) повільніше порівнянно
  з доступом, який не кешується. На 68060 доступ як на читання, так і на запис
  буде скасовано й перезапущенно. Доступ на читання буде приблизно в 3 рази повільніше,
  а доступ на запис повільніше приблизно в 5 разів. <br>
  Згадані вище проблеми пов'язані з доступом до даних. Доступ до команд звичайно
  не викликає проблем і також кешується в Chip-пам'яті. Але існують деякі апаратні
  засоби (можливо, просто неісправні), які не дозволяють кешування команд в Chip-пам'яті.
  На таких системах повинна використовуватися опція <a
href="opt.html#ChipNoCache">ChipNoCache/S</a>, щоб уникнути значного уповільнення
  в роботі встановленої програми, оскільки інакше (без використання цієї опції)
  доступ до інструкцій буде проходити приблизно в 2 рази повільніше.</p>

<p>Ви можете перевірити роботу вашого комп'ютера стасовно цього параметру шляхом
  запуску модуля <i>Speed.Slave</i>, який знаходиться в директорії <tt>src/memory-speed</tt>
  архіву для розробників. </p>

<h4>Кешування даних під час запису (Write Allocation)</h4>

<p>Кешування даних при записі управляє роботою кеша на процесорах 68030 коли при
  операції запису відбувається втрата кеша. Кешування даних в момент запису повинно
  бути активізовано, коли програма запущена в режимі користувача (User Mode).
  Якщо встановлена програма запускається тільки в режимі супервайзера (Supervisor
  Mode), те кешування даних під час запису може бути відключено, що може дати
  невеликий приріст швидкості. </p>

<h4>Кеш розгалуження (Branch Cache)</h4>

<p>Кеш розгалуження доступне тільки на 68060. Це свого роду кеш інструкції для
  команд переходу. Але на відміну від кеша команд не залежить від установок MMU!
  Це означає, що навіть якщо сторінка пам'яті позначається такою, що не кешується,
  команди переходу всеодно будуть кешуватися за умови, що активно кеш розгалуження.
</p>

<hr>

<p>За додатковою інформацією звертайтеся до довідника по мікропроцесорах Motorola.
  Якщо у вас є зауваження або доповнення які хотілося б бачити на цій сторінці,
  будь ласка напишіть <a
href="mailto:wepl@whdload.de">мені</a> . <br>
</p>
</body>
</html>
